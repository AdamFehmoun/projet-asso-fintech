This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
lib/
  utils.ts
public/
  file.svg
  globe.svg
  next.svg
  vercel.svg
  window.svg
src/
  app/
    (auth)/
      login/
        actions.ts
        page.tsx
    (dashboard)/
      [org_slug]/
        budget/
          new/
            page.tsx
          actions.ts
          analytics-actions.ts
          page.tsx
        members/
          actions.ts
          page.tsx
        settings/
          actions.ts
          page.tsx
        actions.ts
        layout.tsx
        page.tsx
    (marketing)/
      page.tsx
    actions/
      get-receipt-url.ts
      scan-receipt.ts
    api/
      webhooks/
        stripe/
          route.ts
    onboarding/
      actions.ts
      page.tsx
    globals.css
    layout.tsx
  components/
    charts/
      cashflow-chart.tsx
      expense-donut-chart.tsx
    dashboard/
      budget-tree-view.tsx
      event-card.tsx
      runway-card.tsx
      transaction-detail-sheet.tsx
    forms/
      receipt-uploader.tsx
    settings/
      ai-sync-button.tsx
      category-item.tsx
      category-list.tsx
      rule-manager.tsx
    ui/
      card.tsx
      chart.tsx
      separator.tsx
      sheet.tsx
  lib/
    ai.ts
    data-structures.ts
    stripe.ts
    supabase-middleware.ts
    supabase-server.ts
    supabase.ts
    sync-vectors.ts
    utils.ts
  types/
    budget.ts
  middleware.ts
supabase/
  .temp/
    cli-latest
    gotrue-version
    pooler-url
    postgres-version
    project-ref
    rest-version
    storage-migration
    storage-version
  config.toml
.gitignore
architecture.txt
components.json
deploy.sql
eslint.config.mjs
next.config.ts
package.json
postcss.config.mjs
README.md
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/app/(dashboard)/[org_slug]/budget/analytics-actions.ts">
'use server';

import { createClient } from "@/lib/supabase-server";
import { getTransactions } from "../actions"; // âœ… L'IMPORT MANQUANT EST ICI

export type BudgetNode = {
  id: string;
  name: string;
  color: string;
  parent_id: string | null;
  rank: number;
  direct_total: number;
  recursive_total: number;
  children: BudgetNode[]; 
};

/**
 * RÃ©cupÃ¨re l'arbre analytique complet (sommes rÃ©cursives) via RPC
 */
export async function getBudgetAnalytics(org_slug: string) {
  const supabase = await createClient();

  // console.log("ğŸ› ï¸ Calling RPC for slug:", org_slug);

  // On appelle la fonction SQL rÃ©cursive qu'on a crÃ©Ã©e prÃ©cÃ©demment
  const { data, error } = await supabase.rpc('get_hierarchical_budget', {
    org_slug_param: org_slug 
  });

  if (error) {
    console.error("âŒ DÃ©tails Erreur SQL Analytics:", {
      code: error.code,
      message: error.message,
      details: error.details
    });
    return [];
  }

  if (!data || data.length === 0) return [];

  // On transforme la liste plate SQL en arbre TypeScript
  return buildAnalyticsTree(data);
}

/**
 * Calcule la santÃ© financiÃ¨re (Runway, Burn Rate)
 */
export async function getFinancialHealth(org_slug: string) {
  // âœ… Maintenant cette fonction est dÃ©finie grÃ¢ce Ã  l'import ligne 4
  const transactions = await getTransactions(org_slug); 
  
  const now = new Date();
  const threeMonthsAgo = new Date();
  threeMonthsAgo.setMonth(now.getMonth() - 3);

  // 1. Calcul du Burn Rate (Moyenne des dÃ©penses des 3 derniers mois)
  const recentExpenses = transactions.filter((t: any) => 
    t.type === 'expense' && new Date(t.date) >= threeMonthsAgo
  );

  // Somme des dÃ©penses rÃ©centes
  const totalRecentExpense = recentExpenses.reduce((sum: number, t: any) => sum + t.amount, 0);
  
  // Moyenne mensuelle (si pas de dÃ©pense, 0)
  const monthlyBurnRate = totalRecentExpense / 3;

  // 2. Calcul du Solde Actuel (Total Recettes - Total DÃ©penses)
  const totalIncome = transactions.filter((t: any) => t.type === 'income').reduce((sum: number, t: any) => sum + t.amount, 0);
  const totalExpense = transactions.filter((t: any) => t.type === 'expense').reduce((sum: number, t: any) => sum + t.amount, 0);
  const currentBalance = totalIncome - totalExpense;

  // 3. Calcul du Runway (en mois)
  // Si burn rate <= 0, on considÃ¨re que la survie est "infinie"
  const runwayMonths = monthlyBurnRate > 0 
    ? (currentBalance / monthlyBurnRate) 
    : Infinity;

  return {
    monthlyBurnRate: Math.round(monthlyBurnRate),
    runwayMonths: runwayMonths === Infinity ? Infinity : parseFloat(runwayMonths.toFixed(1)),
    currentBalance
  };
}

/**
 * Utilitaire pour transformer la liste plate en arbre
 */
function buildAnalyticsTree(nodes: any[]): BudgetNode[] {
  const map = new Map<string, BudgetNode>();
  const roots: BudgetNode[] = [];

  // 1. Init Map
  nodes.forEach(n => {
    map.set(n.id, { ...n, children: [] });
  });

  // 2. Build Tree
  nodes.forEach(n => {
    const node = map.get(n.id)!;
    if (n.parent_id && map.has(n.parent_id)) {
      map.get(n.parent_id)!.children.push(node);
    } else {
      roots.push(node);
    }
  });

  // 3. Sort by rank recursive
  const sortNodes = (list: BudgetNode[]) => {
    list.sort((a, b) => (a.rank || 0) - (b.rank || 0));
    list.forEach(node => {
      if (node.children.length > 0) sortNodes(node.children);
    });
  };
  
  sortNodes(roots);
  return roots;
}
</file>

<file path="src/components/charts/expense-donut-chart.tsx">
'use client';

import { Cell, Pie, PieChart, ResponsiveContainer, Tooltip, Legend } from "recharts";
import { BudgetNode } from "@/app/(dashboard)/[org_slug]/budget/analytics-actions";

const formatEur = (val: number) => 
  new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(val);

export function ExpenseDonutChart({ data }: { data: BudgetNode[] }) {
  // On filtre pour ne garder que les catÃ©gories qui ont des dÃ©penses > 0
  const chartData = data
    .filter(node => node.recursive_total > 0)
    .map(node => ({
      name: node.name,
      value: node.recursive_total / 100, // Conversion centimes -> euros
      color: node.color
    }));

  if (chartData.length === 0) {
    return (
      <div className="h-[300px] flex items-center justify-center text-slate-400 italic text-sm">
        Aucune donnÃ©e de dÃ©pense Ã  analyser
      </div>
    );
  }

  return (
    <div className="h-[300px] w-full">
      <ResponsiveContainer width="100%" height="100%">
        <PieChart>
          <Pie
            data={chartData}
            cx="50%"
            cy="50%"
            innerRadius={60}
            outerRadius={80}
            paddingAngle={5}
            dataKey="value"
          >
            {chartData.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={entry.color || '#64748b'} stroke="none" />
            ))}
          </Pie>
          <Tooltip 
            formatter={(value: number) => formatEur(value)}
            contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
          />
          <Legend 
            verticalAlign="bottom" 
            align="center"
            iconType="circle"
            wrapperStyle={{ fontSize: '12px', paddingTop: '20px' }}
          />
        </PieChart>
      </ResponsiveContainer>
    </div>
  );
}
</file>

<file path="src/components/dashboard/budget-tree-view.tsx">
'use client';

import { useState } from "react";
import { ChevronRight, ChevronDown, FolderOpen } from "lucide-react"; // âœ… Ajout FolderOpen
import { BudgetNode } from "@/app/(dashboard)/[org_slug]/budget/analytics-actions";

const formatEur = (cents: number) => 
  new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(cents / 100);

// On passe maxTotal pour calculer le % relatif au parent (Drill-down)
function TreeNode({ node, maxTotal }: { node: BudgetNode, maxTotal: number }) {
  const [isOpen, setIsOpen] = useState(true);
  const hasChildren = node.children && node.children.length > 0;
  
  // % relatif : Si je suis une sous-catÃ©gorie, combien je pÃ¨se dans mon parent ?
  const percentage = maxTotal > 0 ? (node.recursive_total / maxTotal) * 100 : 0;
  const isZero = node.recursive_total === 0;

  return (
    <div className="flex flex-col">
      {/* Ligne Principale */}
      <div className="flex items-center gap-2 py-2 group hover:bg-slate-50 rounded-lg pr-2 transition-colors">
        <div className="w-6 flex justify-center shrink-0">
          {hasChildren ? (
            <button onClick={() => setIsOpen(!isOpen)} className="p-1 hover:bg-slate-200 rounded text-slate-400">
              {isOpen ? <ChevronDown className="w-3.5 h-3.5" /> : <ChevronRight className="w-3.5 h-3.5" />}
            </button>
          ) : (
            <div className="w-3.5" /> 
          )}
        </div>

        <div className="flex-1 min-w-0">
          <div className="flex justify-between items-center mb-1.5">
            <div className="flex items-center gap-2 overflow-hidden">
               <div 
                 className={`w-2 h-2 rounded-full shrink-0 ${isZero ? 'opacity-30' : ''}`} 
                 style={{ backgroundColor: node.color || '#cbd5e1' }} 
               />
               <span className={`text-sm font-medium truncate ${isZero ? 'text-slate-400' : 'text-slate-700'}`}>
                 {node.name}
               </span>
            </div>
            <div className="text-right shrink-0 ml-4">
              <span className={`text-sm font-bold ${isZero ? 'text-slate-300' : 'text-slate-900'}`}>
                {formatEur(node.recursive_total)}
              </span>
            </div>
          </div>
          
          {/* Barre de Progression */}
          <div className="relative h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
             <div 
               className="absolute top-0 left-0 h-full rounded-full transition-all duration-700 ease-out"
               style={{ 
                 width: `${percentage}%`, 
                 backgroundColor: isZero ? '#e2e8f0' : (node.color || '#64748b'),
                 opacity: 0.8
               }}
             />
          </div>
          
          {/* Info "Direct" si diffÃ©rent du total */}
          {node.direct_total > 0 && node.direct_total !== node.recursive_total && isOpen && (
             <p className="text-[10px] text-slate-400 mt-1 pl-4">
                Dont {formatEur(node.direct_total)} directs
             </p>
          )}
        </div>
      </div>

      {/* RÃ©cursion : Les enfants sont relatifs Ã  MOI (node.recursive_total) */}
      {isOpen && hasChildren && (
        <div className="ml-4 pl-4 border-l border-slate-100 flex flex-col">
          {node.children.map(child => (
            <TreeNode key={child.id} node={child} maxTotal={node.recursive_total || 1} />
          ))}
        </div>
      )}
    </div>
  );
}

export function BudgetTreeView({ data }: { data: BudgetNode[] }) {
  // Pour le niveau racine, on compare au total global
  const totalRoot = data.reduce((acc, n) => acc + n.recursive_total, 0);

  if (data.length === 0) {
    return (
        <div className="p-8 text-center border border-dashed rounded-xl border-slate-200 bg-slate-50 h-full flex items-center justify-center">
            <p className="text-slate-400 text-sm">Aucune donnÃ©e budgÃ©taire.</p>
        </div>
    );
  }

  return (
    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-full flex flex-col">
      <div className="flex items-center gap-3 mb-6">
        <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg">
           <FolderOpen className="w-5 h-5" />
        </div>
        <div>
            <h3 className="font-bold text-slate-900">Analyse Structurelle</h3>
            <p className="text-xs text-slate-500">Roll-up des dÃ©penses</p>
        </div>
      </div>
      
      <div className="flex-1 overflow-y-auto pr-2 space-y-1 custom-scrollbar">
        {data.map(node => (
          <TreeNode key={node.id} node={node} maxTotal={totalRoot} />
        ))}
      </div>
      
      <div className="mt-4 pt-4 border-t border-slate-100 text-xs text-slate-400 flex justify-between">
         <span>Total AnalysÃ©</span>
         <span className="font-mono font-medium">{formatEur(totalRoot)}</span>
      </div>
    </div>
  );
}
</file>

<file path="src/components/dashboard/runway-card.tsx">
// src/components/dashboard/runway-card.tsx
import { Timer, AlertTriangle, Zap } from "lucide-react";

export function RunwayCard({ health }: { health: any }) {
  const isCritical = health.runwayMonths <= 2;
  
  return (
    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
      {isCritical && <div className="absolute top-0 left-0 w-full h-1 bg-red-500 animate-pulse" />}
      
      <div className="flex items-center justify-between mb-4">
        <div className={`p-2 rounded-lg ${isCritical ? 'bg-red-50 text-red-600' : 'bg-indigo-50 text-indigo-600'}`}>
          <Timer className="w-5 h-5" />
        </div>
        <span className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Projection de survie</span>
      </div>

      <div className="space-y-1">
        <h3 className="text-3xl font-black text-slate-900">
          {health.runwayMonths === Infinity ? "âˆ" : health.runwayMonths} 
          <span className="text-sm font-bold text-slate-400 ml-1 whitespace-nowrap">mois restants</span>
        </h3>
        <p className="text-xs text-slate-500">
          BasÃ© sur un burn rate de <span className="font-bold">{(health.monthlyBurnRate / 100).toLocaleString()}â‚¬/mois</span>
        </p>
      </div>

      {/* Jauge Visuelle */}
      <div className="mt-6 w-full h-2 bg-slate-100 rounded-full overflow-hidden">
        <div 
          className={`h-full transition-all duration-1000 ${isCritical ? 'bg-red-500' : 'bg-indigo-500'}`}
          style={{ width: `${Math.min((health.runwayMonths / 12) * 100, 100)}%` }}
        />
      </div>
      
      <div className="mt-4 flex items-center gap-2">
        {isCritical ? (
          <div className="flex items-center gap-1 text-[10px] font-bold text-red-600 uppercase">
            <AlertTriangle className="w-3 h-3" /> Danger : Fond critique
          </div>
        ) : (
          <div className="flex items-center gap-1 text-[10px] font-bold text-emerald-600 uppercase">
            <Zap className="w-3 h-3" /> TrÃ©sorerie saine
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/settings/ai-sync-button.tsx">
'use client';

import { useState } from "react";
import { Sparkles, Loader2, CheckCircle2 } from "lucide-react";
import { triggerAiSync } from "@/app/(dashboard)/[org_slug]/settings/actions";
import { useParams } from "next/navigation";
import { toast } from "sonner";

export function AiSyncButton() {
  const [loading, setLoading] = useState(false);
  const { org_slug } = useParams();

  const handleSync = async () => {
    setLoading(true);
    try {
      const result = await triggerAiSync(org_slug as string);
      if (result.success) {
        toast.success(`${result.count} catÃ©gories vectorisÃ©es avec succÃ¨s !`);
      } else {
        toast.error("Ã‰chec de la synchronisation vectorielle");
      }
    } catch (error) {
      toast.error("Une erreur technique est survenue.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-6 flex flex-col md:flex-row items-center justify-between gap-4">
      <div className="flex items-center gap-4">
        <div className="p-3 bg-indigo-600 text-white rounded-lg shadow-sm">
          <Sparkles className="w-5 h-5" />
        </div>
        <div>
          <h4 className="text-sm font-bold text-indigo-900">Moteur de Recherche Vectoriel</h4>
          <p className="text-xs text-indigo-700 max-w-sm">
            Transforme ton plan comptable en vecteurs mathÃ©matiques pour permettre le classement automatique des transactions.
          </p>
        </div>
      </div>
      
      <button
        onClick={handleSync}
        disabled={loading}
        className="w-full md:w-auto flex items-center justify-center gap-2 px-6 py-2.5 bg-white border border-indigo-200 text-indigo-600 rounded-lg text-sm font-semibold hover:bg-indigo-50 transition-all shadow-sm disabled:opacity-50"
      >
        {loading ? (
          <>
            <Loader2 className="w-4 h-4 animate-spin" />
            Calcul des Embeddings...
          </>
        ) : (
          <>
            <CheckCircle2 className="w-4 h-4" />
            Synchroniser
          </>
        )}
      </button>
    </div>
  );
}
</file>

<file path="src/components/settings/category-item.tsx">
'use client';

import { useSortable } from "@dnd-kit/sortable";
import { CSS } from "@dnd-kit/utilities";
import { GripVertical, Folder, Trash2, Edit2 } from "lucide-react";
import { cn } from "@/lib/utils"; // Assure-toi d'avoir cette fonction utilitaire, sinon utilise clsx

interface CategoryItemProps {
  category: any;
  depth: number;
}

export function CategoryItem({ category, depth }: CategoryItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: category.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    marginLeft: `${depth * 24}px`, // ğŸ‘ˆ L'indentation visuelle de l'arbre
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        "group flex items-center gap-3 p-3 bg-white border border-slate-200 rounded-lg mb-2 transition-all",
        isDragging && "opacity-50 border-dashed border-slate-400 bg-slate-50 z-50 relative"
      )}
    >
      {/* PoignÃ©e de Drag & Drop */}
      <div {...attributes} {...listeners} className="cursor-grab text-slate-400 hover:text-slate-600">
        <GripVertical className="w-5 h-5" />
      </div>

      {/* IcÃ´ne et Couleur */}
      <div 
        className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs shadow-sm"
        style={{ backgroundColor: category.color }}
      >
        {category.name.charAt(0).toUpperCase()}
      </div>

      {/* Nom */}
      <div className="flex-grow">
        <p className="font-medium text-slate-900">{category.name}</p>
        <p className="text-xs text-slate-400">ID: {category.id.slice(0, 8)}...</p>
      </div>

      {/* Actions (Edit / Delete) */}
      <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
        <button className="p-2 hover:bg-slate-100 rounded-md text-slate-500">
          <Edit2 className="w-4 h-4" />
        </button>
        <button className="p-2 hover:bg-red-50 rounded-md text-red-500">
          <Trash2 className="w-4 h-4" />
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/settings/category-list.tsx">
'use client';

import { useState, useId } from "react";
import { useParams } from "next/navigation";
import { 
  DndContext, 
  closestCenter, 
  KeyboardSensor, 
  PointerSensor, 
  useSensor, 
  useSensors, 
  DragEndEvent 
} from "@dnd-kit/core";
import { 
  arrayMove, 
  SortableContext, 
  sortableKeyboardCoordinates, 
  verticalListSortingStrategy,
  useSortable
} from "@dnd-kit/sortable";
import { CSS } from "@dnd-kit/utilities";
import { 
  GripVertical, 
  Plus, 
  Trash2, 
  CornerDownRight, 
  CheckCircle 
} from "lucide-react";
import { createCategory, deleteCategory, updateCategoryOrder } from "@/app/(dashboard)/[org_slug]/settings/actions";
import { toast } from "sonner";

// --- TYPES & UTILS ---

type CategoryNode = {
  id: string;
  name: string;
  color: string;
  children?: CategoryNode[];
  parent_id: string | null;
  depth?: number;
};

// Aplatit l'arbre pour le rendre compatible avec une liste Sortable verticale
const flattenTree = (nodes: CategoryNode[], depth = 0): CategoryNode[] => {
  return nodes.reduce((acc, node) => {
    const flatNode = { ...node, depth };
    const children = node.children ? flattenTree(node.children, depth + 1) : [];
    return [...acc, flatNode, ...children];
  }, [] as CategoryNode[]);
};

// --- COMPOSANT PRINCIPAL ---

export function CategoryList({ initialData }: { initialData: CategoryNode[] }) {
  const [items, setItems] = useState(() => flattenTree(initialData));
  const [isAddingRoot, setIsAddingRoot] = useState(false);
  const params = useParams();
  const orgSlug = params.org_slug as string;
  
  const dndContextId = useId();

  const sensors = useSensors(
    useSensor(PointerSensor, { activationConstraint: { distance: 5 } }), // Ã‰vite le drag accidentel au click
    useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
  );

  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;

    if (over && active.id !== over.id) {
      const oldIndex = items.findIndex((i) => i.id === active.id);
      const newIndex = items.findIndex((i) => i.id === over.id);
      
      // Mise Ã  jour Optimistic
      const newItems = arrayMove(items, oldIndex, newIndex);
      setItems(newItems);

      // Sauvegarde serveur
      try {
        const updates = newItems.map((item, index) => ({
          id: item.id,
          rank: index,
        }));
        await updateCategoryOrder(updates, orgSlug);
      } catch (error) {
        toast.error("Erreur lors de la rÃ©organisation");
        console.error(error);
      }
    }
  };

  return (
    <div className="space-y-4">
      {/* Bouton d'ajout racine */}
      <button 
        onClick={() => setIsAddingRoot(true)}
        className="text-xs font-bold uppercase tracking-widest text-slate-500 hover:text-slate-800 flex items-center gap-2 px-2"
      >
        <Plus className="w-4 h-4" /> Ajouter une catÃ©gorie principale
      </button>

      {isAddingRoot && (
        <div className="p-4 bg-slate-50 rounded-xl border border-slate-200 mb-4 animate-in fade-in slide-in-from-top-2">
           <AddCategoryForm 
             parentId={null} 
             orgSlug={orgSlug} 
             onClose={() => setIsAddingRoot(false)} 
           />
        </div>
      )}

      {/* Liste Drag & Drop */}
      <DndContext 
        id={dndContextId}
        sensors={sensors} 
        collisionDetection={closestCenter} 
        onDragEnd={handleDragEnd}
      >
        <SortableContext 
          items={items.map(i => i.id)} 
          strategy={verticalListSortingStrategy}
        >
          <div className="space-y-1">
            {items.map((cat) => (
              <SortableCategoryItem 
                key={cat.id} 
                category={cat} 
                orgSlug={orgSlug}
              />
            ))}
          </div>
        </SortableContext>
      </DndContext>

      {items.length === 0 && !isAddingRoot && (
        <div className="text-center py-10 text-slate-400 text-xs border-2 border-dashed border-slate-100 rounded-xl">
            Aucune catÃ©gorie dÃ©finie.
        </div>
      )}
    </div>
  );
}

// --- SOUS-COMPOSANT : L'ITEM DRAGGABLE ---

function SortableCategoryItem({ category, orgSlug }: { category: CategoryNode, orgSlug: string }) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging
  } = useSortable({ id: category.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    marginLeft: `${(category.depth || 0) * 24}px`, // Indentation visuelle
    opacity: isDragging ? 0.5 : 1,
  };

  const [isAddingChild, setIsAddingChild] = useState(false);

  return (
    <div className="group">
        <div 
            ref={setNodeRef} 
            style={style} 
            className="flex items-center py-2 px-3 bg-white hover:bg-slate-50 border border-transparent hover:border-slate-200 rounded-lg mb-1 transition-colors relative"
        >
            {/* PoignÃ©e de Drag */}
            <div {...attributes} {...listeners} className="cursor-grab text-slate-300 hover:text-slate-600 mr-2">
                <GripVertical className="w-4 h-4" />
            </div>

            {/* Pastille Couleur */}
            <div 
                className="w-3 h-3 rounded-full mr-3 shrink-0 shadow-sm" 
                style={{ backgroundColor: category.color }} 
            />

            {/* Nom */}
            <span className="text-sm font-medium text-slate-700 flex-1">
                {category.name}
            </span>

            {/* Actions (CRUD) */}
            <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button 
                    onClick={() => setIsAddingChild(true)}
                    className="p-1.5 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded transition"
                    title="Ajouter une sous-catÃ©gorie"
                >
                    <Plus className="w-3.5 h-3.5" />
                </button>
                <button 
                    onClick={async () => {
                        if(confirm(`Supprimer "${category.name}" ?`)) {
                            await deleteCategory(category.id, orgSlug);
                            toast.success("SupprimÃ©");
                        }
                    }}
                    className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition"
                    title="Supprimer"
                >
                    <Trash2 className="w-3.5 h-3.5" />
                </button>
            </div>
        </div>

        {/* Formulaire d'ajout enfant (Hors du drag context visuel) */}
        {isAddingChild && (
            <div 
                style={{ marginLeft: `${((category.depth || 0) + 1) * 24}px` }} 
                className="mb-2 py-1 animate-in fade-in slide-in-from-left-2"
            >
                <AddCategoryForm 
                    parentId={category.id} 
                    orgSlug={orgSlug} 
                    onClose={() => setIsAddingChild(false)} 
                />
            </div>
        )}
    </div>
  );
}

// --- FORMULAIRE D'AJOUT ---

function AddCategoryForm({ parentId, orgSlug, onClose }: any) {
    return (
        <form action={async (formData) => {
            await createCategory(formData);
            toast.success("CatÃ©gorie crÃ©Ã©e !");
            onClose();
        }} className="flex items-center gap-2">
            <CornerDownRight className="w-4 h-4 text-slate-300" />
            <input type="hidden" name="org_slug" value={orgSlug} />
            <input type="hidden" name="parent_id" value={parentId || 'root'} />
            
            <input 
                name="name" 
                placeholder="Nom..." 
                className="px-2 py-1 text-sm border rounded bg-white focus:ring-2 focus:ring-indigo-500 outline-none w-48 shadow-sm"
                autoFocus 
                required
            />
            <input 
                name="color" 
                type="color" 
                className="w-8 h-8 p-0 border-none rounded cursor-pointer shadow-sm"
                defaultValue="#6366f1"
            />
            <button type="submit" className="p-1.5 bg-emerald-500 text-white rounded hover:bg-emerald-600 transition shadow-sm">
                <CheckCircle className="w-3.5 h-3.5" />
            </button>
            <button type="button" onClick={onClose} className="p-1.5 text-slate-400 hover:text-slate-600">
                x
            </button>
        </form>
    );
}
</file>

<file path="src/components/settings/rule-manager.tsx">
// src/components/settings/rule-manager.tsx
'use client';

import { useState } from "react";
import { Plus, Trash2, ShieldCheck } from "lucide-react";
import { createRule, deleteRule } from "@/app/(dashboard)/[org_slug]/settings/actions";
import { toast } from "sonner";

export function RuleManager({ categories, initialRules, orgSlug }: any) {
  const [loading, setLoading] = useState(false);

  async function handleAdd(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    setLoading(true);
    const formData = new FormData(e.currentTarget);
    formData.append('org_slug', orgSlug);
    
    await createRule(formData);
    setLoading(false);
    (e.target as HTMLFormElement).reset();
    toast.success("RÃ¨gle ajoutÃ©e avec succÃ¨s");
  }

  return (
    <div className="space-y-6">
      {/* Formulaire d'ajout rapide */}
      <form onSubmit={handleAdd} className="flex flex-col sm:flex-row gap-3 bg-slate-50 p-4 rounded-xl border border-slate-200">
        <div className="flex-1">
          <input 
            name="pattern"
            placeholder="Si la description contient..." 
            className="w-full p-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
            required
          />
        </div>
        <div className="flex-1">
          <select 
            name="category_id" 
            className="w-full p-2 text-sm border rounded-lg bg-white outline-none"
            required
          >
            <option value="">Alors classer dans...</option>
            {categories.map((cat: any) => (
              <option key={cat.id} value={cat.id}>{cat.name}</option>
            ))}
          </select>
        </div>
        <button 
          type="submit" 
          disabled={loading}
          className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2"
        >
          {loading ? "..." : <Plus className="w-4 h-4" />}
          Ajouter
        </button>
      </form>

      {/* Liste des rÃ¨gles actives */}
      <div className="border rounded-xl overflow-hidden bg-white">
        <table className="w-full text-sm text-left">
          <thead className="bg-slate-50 border-b">
            <tr>
              <th className="px-4 py-3 font-bold text-slate-500 uppercase text-[10px]">Mot-clÃ©</th>
              <th className="px-4 py-3 font-bold text-slate-500 uppercase text-[10px]">Action</th>
              <th className="px-4 py-3 text-right"></th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {initialRules.map((rule: any) => (
              <tr key={rule.id} className="hover:bg-slate-50 transition-colors">
                <td className="px-4 py-3 font-mono text-indigo-600 font-semibold italic">"{rule.pattern}"</td>
                <td className="px-4 py-3 flex items-center gap-2">
                  <ShieldCheck className="w-3 h-3 text-emerald-500" />
                  <span>{rule.budget_categories?.name}</span>
                </td>
                <td className="px-4 py-3 text-right">
                  <button 
                    onClick={() => deleteRule(rule.id, orgSlug)}
                    className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ui/separator.tsx">
"use client"

import * as React from "react"
import { Separator as SeparatorPrimitive } from "radix-ui"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }
</file>

<file path="src/lib/data-structures.ts">
import { CategoryNode } from "@/types/budget";

/**
 * Transforme une liste plate SQL en structure d'arbre rÃ©cursive.
 * ComplexitÃ© : O(n) - TrÃ¨s performant.
 */
export function buildCategoryTree(categories: any[]): CategoryNode[] {
  const map = new Map<string, CategoryNode>();
  const roots: CategoryNode[] = [];

  // 1. Initialisation de la Map pour accÃ¨s O(1)
  categories.forEach((cat) => {
    map.set(cat.id, { ...cat, children: [], depth: 0 });
  });

  // 2. Construction des liens Parent-Enfant
  categories.forEach((cat) => {
    const node = map.get(cat.id);
    if (!node) return;

    if (cat.parent_id && map.has(cat.parent_id)) {
      const parent = map.get(cat.parent_id);
      // On calcule la profondeur pour l'indentation visuelle
      node.depth = (parent?.depth || 0) + 1;
      parent?.children?.push(node);
    } else {
      // Si pas de parent, c'est une racine (Niveau 0)
      roots.push(node);
    }
  });

  return roots;
}
</file>

<file path="src/lib/sync-vectors.ts">
import { createClient } from "@/lib/supabase-server";
import { generateEmbedding } from "@/lib/ai";

export async function syncCategoriesToVectors(org_slug: string) {
  const supabase = await createClient();

  // 1. RÃ©cupÃ©rer l'orga
  const { data: org } = await supabase
    .from('organizations')
    .select('id')
    .eq('slug', org_slug)
    .single();

  if (!org) throw new Error("Organisation introuvable");

  // 2. RÃ©cupÃ©rer toutes les catÃ©gories
  const { data: categories } = await supabase
    .from('budget_categories')
    .select('id, name')
    .eq('organization_id', org.id);

  if (!categories || categories.length === 0) return 0;

  console.log(`ğŸ“¡ Synchronisation vectorielle : ${categories.length} catÃ©gories Ã  traiter...`);

  // 3. Pipeline Quant : ParallÃ©lisation massive des appels OpenAI
  const updates = await Promise.all(
    categories.map(async (cat) => {
      try {
        const vector = await generateEmbedding(cat.name);
        return { id: cat.id, embedding: vector };
      } catch (err) {
        console.error(`âŒ Ã‰chec embedding pour "${cat.name}":`, err);
        return null;
      }
    })
  );

  const validUpdates = updates.filter((u): u is { id: string; embedding: number[] } => u !== null);

  // 4. Update en batch (SÃ©quentiel pour Ã©viter de saturer les connexions DB)
  for (const update of validUpdates) {
    await supabase
      .from('budget_categories')
      .update({ embedding: update.embedding })
      .eq('id', update.id);
  }

  console.log(`âœ… ${validUpdates.length} catÃ©gories vectorisÃ©es avec succÃ¨s.`);
  return validUpdates.length;
}
</file>

<file path="src/types/budget.ts">
export type CategoryNode = {
  id: string;
  name: string;
  color: string;
  parent_id: string | null;
  children?: CategoryNode[]; // Pour l'affichage rÃ©cursif (Arbre)
  depth?: number; // Pour l'indentation visuelle
};

export type TransactionWithCategory = {
  id: string;
  amount: number;
  date: string;
  description: string;
  type: 'income' | 'expense';
  receipt_url: string | null;
  // La jointure nous donnera Ã§a :
  budget_categories: {
    name: string;
    color: string;
    parent_id: string | null;
  } | null;
};
</file>

<file path="architecture.txt">
.
â”œâ”€â”€ README.md
â”œâ”€â”€ architecture.txt
â”œâ”€â”€ components.json
â”œâ”€â”€ deploy.sql
â”œâ”€â”€ eslint.config.mjs
â”œâ”€â”€ lib
â”‚Â Â  â””â”€â”€ utils.ts
â”œâ”€â”€ next-env.d.ts
â”œâ”€â”€ next.config.ts
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ postcss.config.mjs
â”œâ”€â”€ public
â”‚Â Â  â”œâ”€â”€ file.svg
â”‚Â Â  â”œâ”€â”€ globe.svg
â”‚Â Â  â”œâ”€â”€ next.svg
â”‚Â Â  â”œâ”€â”€ vercel.svg
â”‚Â Â  â””â”€â”€ window.svg
â”œâ”€â”€ repomix-output.xml
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ app
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ (auth)
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ login
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ actions.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ page.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ (dashboard)
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ [org_slug]
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ actions.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ budget
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ actions.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ analytics-actions.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ new
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ page.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ page.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ layout.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ members
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ actions.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ page.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ page.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ settings
â”‚Â Â  â”‚Â Â  â”‚Â Â          â”œâ”€â”€ actions.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ page.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ (marketing)
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ page.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ actions
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ get-receipt-url.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ scan-receipt.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ api
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ chat
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ webhooks
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ stripe
â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ route.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ globals.css
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ layout.tsx
â”‚Â Â  â”‚Â Â  â””â”€â”€ onboarding
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ actions.ts
â”‚Â Â  â”‚Â Â      â””â”€â”€ page.tsx
â”‚Â Â  â”œâ”€â”€ components
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ charts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cashflow-chart.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ expense-donut-chart.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dashboard
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ budget-tree-view.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ event-card.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ runway-card.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ transaction-detail-sheet.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ forms
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ receipt-uploader.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ settings
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ai-sync-button.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ category-item.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ category-list.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ rule-manager.tsx
â”‚Â Â  â”‚Â Â  â””â”€â”€ ui
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ card.tsx
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ chart.tsx
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ separator.tsx
â”‚Â Â  â”‚Â Â      â””â”€â”€ sheet.tsx
â”‚Â Â  â”œâ”€â”€ lib
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ai.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ data-structures.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ stripe.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ supabase-middleware.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ supabase-server.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ supabase.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ sync-vectors.ts
â”‚Â Â  â”‚Â Â  â””â”€â”€ utils.ts
â”‚Â Â  â”œâ”€â”€ middleware.ts
â”‚Â Â  â””â”€â”€ types
â”‚Â Â      â””â”€â”€ budget.ts
â”œâ”€â”€ supabase
â”‚Â Â  â”œâ”€â”€ config.toml
â”‚Â Â  â””â”€â”€ snippets
â”œâ”€â”€ tailwind.config.ts
â””â”€â”€ tsconfig.json

29 directories, 67 files
</file>

<file path="lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="src/app/(dashboard)/[org_slug]/members/actions.ts">
"use server";

import { createClient } from "@/lib/supabase-server";
import { revalidatePath } from "next/cache";

export async function updateMemberStatus(
  memberId: string, 
  newStatus: 'active' | 'rejected', 
  orgSlug: string
) {
  console.log(`ğŸ”„ Tentative mise Ã  jour : Membre ${memberId} -> ${newStatus}`);
  
  const supabase = await createClient();

  // 1. VÃ©rifier que TU es bien admin
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("Non connectÃ©");

  // On vÃ©rifie ton rÃ´le dans cette asso
  const { data: currentUserMember } = await supabase
    .from("members")
    .select("role, organization_id")
    .eq("user_id", user.id)
    .eq("organization_id", (
        await supabase.from("organizations").select("id").eq("slug", orgSlug).single()
      ).data?.id
    )
    .single();

  if (currentUserMember?.role !== 'admin') {
    console.error("â›”ï¸ RefusÃ© : Tu n'es pas admin");
    throw new Error("AccÃ¨s refusÃ©");
  }

  // 2. ExÃ©cuter la mise Ã  jour
  const { error } = await supabase
    .from("members")
    .update({ status: newStatus })
    .eq("id", memberId);

  if (error) {
    console.error("âŒ Erreur SQL Supabase :", error);
    throw new Error("Erreur lors de la mise Ã  jour");
  }

  console.log("âœ… SuccÃ¨s !");
  
  // 3. RafraÃ®chir la page pour voir le changement immÃ©diat
  revalidatePath(`/${orgSlug}/members`);
}
</file>

<file path="src/app/(dashboard)/[org_slug]/members/page.tsx">
import { createClient } from "@/lib/supabase-server";
import { updateMemberStatus } from "./actions";
import { Check, X, Shield, User } from "lucide-react";

// 1. On dÃ©finit params comme une Promise (Obligatoire Next 15)
export default async function MembersPage({ 
  params 
}: { 
  params: Promise<{ org_slug: string }> 
}) {
  const supabase = await createClient();
  
  // 2. ON UTILISE AWAIT ICI (C'est Ã§a qui manquait)
  const { org_slug } = await params;

  // 3. RÃ©cupÃ©rer l'ID de l'asso
  const { data: org, error: orgError } = await supabase
    .from("organizations")
    .select("id, name")
    .eq("slug", org_slug)
    .single();

  // Si org est null, c'est que le slug dans l'URL ne matche pas la BDD
  if (orgError || !org) {
    return (
      <div className="p-8 text-red-500 bg-red-50 rounded-lg border border-red-200">
        <h2 className="font-bold">Organisation introuvable</h2>
        <p className="text-sm">Le slug <strong>{org_slug}</strong> n'existe pas dans la base de donnÃ©es.</p>
      </div>
    );
  }

  // 4. RÃ©cupÃ©rer les membres
  const { data: members } = await supabase
    .from("members")
    .select(`
      id,
      role,
      status,
      created_at,
      profiles ( full_name, email )
    `)
    .eq("organization_id", org.id)
    .order('created_at', { ascending: false });

  const pendingMembers = members?.filter(m => m.status === 'pending') || [];
  const activeMembers = members?.filter(m => m.status === 'active') || [];

  return (
    <div className="max-w-4xl mx-auto p-8">
      <h1 className="text-2xl font-bold mb-6 text-slate-900">Ã‰quipe - {org.name}</h1>

      {/* SECTION 1 : DEMANDES EN ATTENTE */}
      {pendingMembers.length > 0 && (
        <div className="mb-8 bg-amber-50 border border-amber-200 rounded-xl overflow-hidden shadow-sm">
          <div className="px-6 py-4 border-b border-amber-200 bg-amber-100/50 flex items-center gap-2">
            <div className="w-2 h-2 rounded-full bg-amber-500 animate-pulse" />
            <h2 className="font-semibold text-amber-900">Demandes en attente ({pendingMembers.length})</h2>
          </div>
          <div className="divide-y divide-amber-200/50">
            {pendingMembers.map((member) => (
              <div key={member.id} className="p-4 flex items-center justify-between">
                <div>
                  {/* @ts-ignore */}
                  <p className="font-medium text-slate-900">{member.profiles?.full_name || "Sans nom"}</p>
                  {/* @ts-ignore */}
                  <p className="text-sm text-slate-500">{member.profiles?.email}</p>
                </div>
                <div className="flex gap-2">
                  <form action={async () => {
                    "use server";
                    await updateMemberStatus(member.id, 'active', org_slug);
                  }}>
                    <button className="p-2 bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200 transition">
                      <Check className="w-5 h-5" />
                    </button>
                  </form>
                  <form action={async () => {
                    "use server";
                    await updateMemberStatus(member.id, 'rejected', org_slug);
                  }}>
                    <button className="p-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">
                      <X className="w-5 h-5" />
                    </button>
                  </form>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* SECTION 2 : MEMBRES ACTIFS */}
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <table className="w-full text-left">
          <thead className="bg-slate-50 border-b border-slate-200">
            <tr>
              <th className="px-6 py-4 text-xs font-semibold text-slate-500 uppercase">Membre</th>
              <th className="px-6 py-4 text-xs font-semibold text-slate-500 uppercase">RÃ´le</th>
              <th className="px-6 py-4 text-xs font-semibold text-slate-500 uppercase text-right">Date d'arrivÃ©e</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {activeMembers.map((member) => (
              <tr key={member.id} className="hover:bg-slate-50 transition">
                <td className="px-6 py-4">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500">
                      <User className="w-4 h-4" />
                    </div>
                    <div>
                       {/* @ts-ignore */}
                      <p className="font-medium text-slate-900">{member.profiles?.full_name}</p>
                       {/* @ts-ignore */}
                      <p className="text-xs text-slate-500">{member.profiles?.email}</p>
                    </div>
                  </div>
                </td>
                <td className="px-6 py-4">
                  <span className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium ${
                    member.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-slate-100 text-slate-600'
                  }`}>
                    {member.role === 'admin' && <Shield className="w-3 h-3" />}
                    {member.role === 'admin' ? 'Administrateur' : 'Membre'}
                  </span>
                </td>
                <td className="px-6 py-4 text-sm text-slate-500 text-right" suppressHydrationWarning>
                  {new Date(member.created_at).toLocaleDateString('fr-FR')}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/[org_slug]/settings/actions.ts">
'use server';

import { stripe } from "@/lib/stripe";
import { createClient } from "@/lib/supabase-server";
import { redirect } from "next/navigation";
import { revalidatePath } from "next/cache";
import { buildCategoryTree } from "@/lib/data-structures";
import { syncCategoriesToVectors } from "@/lib/sync-vectors"; 

// ============================================================================
// ğŸ¦ PARTIE 1 : STRIPE CONNECT (TrÃ©sorerie)
// ============================================================================

export async function createStripeConnectAccount(org_slug: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("Non authentifiÃ©");

  const { data: org, error: fetchError } = await supabase
    .from('organizations')
    .select('id, stripe_account_id')
    .eq('slug', org_slug)
    .single();

  if (fetchError || !org) throw new Error("Organisation introuvable");

  let accountId = org.stripe_account_id;

  if (!accountId) {
    try {
      const account = await stripe.accounts.create({
        type: 'express',
        country: 'FR',
        email: user.email,
        capabilities: {
          card_payments: { requested: true },
          transfers: { requested: true },
        },
        business_type: 'non_profit',
      });

      accountId = account.id;
      await supabase.from('organizations').update({ stripe_account_id: accountId }).eq('id', org.id);
    } catch (err) {
      console.error("âŒ [Stripe] Erreur technique :", err);
      throw err;
    }
  }

  const appUrl = process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000";
  const accountLink = await stripe.accountLinks.create({
    account: accountId,
    refresh_url: `${appUrl}/${org_slug}/settings`,
    return_url: `${appUrl}/${org_slug}/settings?success=true`,
    type: 'account_onboarding',
  });

  redirect(accountLink.url);
}

// ============================================================================
// ğŸŒ³ PARTIE 2 : PLAN COMPTABLE (Hierarchical & Drag'n'Drop)
// ============================================================================

export async function getCategories(org_slug: string) {
  const supabase = await createClient();
  const { data: org } = await supabase.from('organizations').select('id').eq('slug', org_slug).single();
  if (!org) return [];

  const { data: categories } = await supabase
    .from('budget_categories')
    .select('*')
    .eq('organization_id', org.id)
    .order('rank', { ascending: true });

  return buildCategoryTree(categories || []);
}

export async function createCategory(formData: FormData) {
  const supabase = await createClient();
  const name = formData.get('name') as string;
  const color = formData.get('color') as string;
  const parent_id = formData.get('parent_id') as string || null;
  const org_slug = formData.get('org_slug') as string;

  const { data: org } = await supabase.from('organizations').select('id').eq('slug', org_slug).single();
  if (!org) throw new Error("Organisation introuvable");

  const { count } = await supabase
    .from('budget_categories')
    .select('*', { count: 'exact', head: true })
    .eq('organization_id', org.id);

  await supabase.from('budget_categories').insert({
    organization_id: org.id,
    name,
    color,
    parent_id: parent_id === "root" ? null : parent_id,
    rank: count || 0,
  });

  revalidatePath(`/${org_slug}/settings`);
}

export async function updateCategoryOrder(items: { id: string; rank: number }[], org_slug: string) {
  const supabase = await createClient();
  const promises = items.map((item) => 
    supabase.from('budget_categories').update({ rank: item.rank }).eq('id', item.id)
  );
  await Promise.all(promises);
  revalidatePath(`/${org_slug}/settings`);
}

// âœ… AJOUT CRITIQUE : La fonction manquante pour la suppression
export async function deleteCategory(id: string, org_slug: string) {
  const supabase = await createClient();
  
  const { error } = await supabase
    .from('budget_categories')
    .delete()
    .eq('id', id);

  if (error) throw new Error("Erreur lors de la suppression");

  revalidatePath(`/${org_slug}/settings`);
}

// ============================================================================
// ğŸ¤– PARTIE 3 : IA & VECTORS (Le "Cerveau")
// ============================================================================

export async function triggerAiSync(org_slug: string) {
  try {
    const count = await syncCategoriesToVectors(org_slug);
    revalidatePath(`/${org_slug}/settings`);
    return { success: true, count };
  } catch (error: any) {
    return { success: false, error: error.message || "Erreur inconnue" };
  }
}

// ============================================================================
// âš™ï¸ PARTIE 4 : MOTEUR DE RÃˆGLES (Hard Rules)
// ============================================================================

export async function createRule(formData: FormData) {
  const supabase = await createClient();
  const org_slug = formData.get("org_slug") as string;
  const pattern = formData.get("pattern") as string;
  const category_id = formData.get("category_id") as string;

  const { data: org } = await supabase
    .from('organizations')
    .select('id')
    .eq('slug', org_slug)
    .single();

  if (!org) throw new Error("Organisation introuvable");

  const { error } = await supabase.from('budget_rules').insert({
    organization_id: org.id,
    pattern,
    category_id
  });

  if (error) throw new Error("Erreur lors de la crÃ©ation de la rÃ¨gle");

  revalidatePath(`/${org_slug}/settings`);
}

export async function deleteRule(id: string, org_slug: string) {
  const supabase = await createClient();
  
  const { error } = await supabase
    .from('budget_rules')
    .delete()
    .eq('id', id);

  if (error) throw new Error("Erreur lors de la suppression");

  revalidatePath(`/${org_slug}/settings`);
}
</file>

<file path="src/app/(dashboard)/[org_slug]/settings/page.tsx">
import { createStripeConnectAccount, getCategories } from "./actions";
import { createClient } from "@/lib/supabase-server";
import { FolderTree, CreditCard, CheckCircle, Sparkles, Gavel } from "lucide-react";
import { CategoryList } from "@/components/settings/category-list"; 
import { AiSyncButton } from "@/components/settings/ai-sync-button"; 
import { RuleManager } from "@/components/settings/rule-manager"; 
import { Separator } from "@/components/ui/separator";

export default async function SettingsPage({ 
  params 
}: { 
  params: Promise<{ org_slug: string }> 
}) {
  const { org_slug } = await params;
  const supabase = await createClient();

  // 1. RÃ©cupÃ©ration des donnÃ©es Org et Stripe
  const { data: org } = await supabase
    .from('organizations')
    .select('id, stripe_account_id, name')
    .eq('slug', org_slug)
    .single();
    
  if (!org) return <div className="p-8 text-red-500">Organisation introuvable</div>;
  const isConnected = !!org?.stripe_account_id;

  // 2. RÃ©cupÃ©ration des donnÃ©es pour l'automatisation
  // On rÃ©cupÃ¨re les catÃ©gories Ã  plat pour le sÃ©lecteur de rÃ¨gles
  const { data: flatCategories } = await supabase
    .from('budget_categories')
    .select('id, name')
    .eq('organization_id', org.id)
    .order('name');

  // On rÃ©cupÃ¨re les rÃ¨gles existantes
  const { data: rules } = await supabase
    .from('budget_rules')
    .select(`
      id, 
      pattern, 
      category_id,
      budget_categories ( name )
    `)
    .eq('organization_id', org.id)
    .order('created_at', { ascending: false });

  // 3. RÃ©cupÃ©ration de l'arbre complet pour l'affichage (Plan Comptable)
  const categoryTree = await getCategories(org_slug);

  return (
    <div className="max-w-7xl mx-auto p-8 space-y-12 pb-20">
      
      {/* --- EN-TÃŠTE --- */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-slate-900 tracking-tight">ParamÃ¨tres</h1>
          <p className="text-slate-500">Configuration de l'espace {org?.name}</p>
        </div>
      </div>
      
      {/* --- SECTION 1 : TRÃ‰SORERIE (STRIPE) --- */}
      <section className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
        <div className="flex items-center gap-3 mb-6">
          <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg">
            <CreditCard className="w-5 h-5" />
          </div>
          <div>
            <h2 className="font-bold text-lg text-slate-800">TrÃ©sorerie & ConnectivitÃ©</h2>
            <p className="text-xs text-slate-500">GÃ©rez vos comptes Stripe pour les paiements en ligne.</p>
          </div>
        </div>
        
        {isConnected ? (
          <div className="bg-emerald-50 border border-emerald-100 text-emerald-700 px-4 py-4 rounded-xl flex items-center justify-between">
            <div className="flex items-center gap-3">
              <CheckCircle className="w-6 h-6 shrink-0" />
              <div>
                <p className="font-bold text-sm">Compte Stripe ConnectÃ©</p>
                <p className="text-xs opacity-80 font-mono mt-0.5">ID: {org.stripe_account_id}</p>
              </div>
            </div>
            <span className="text-[10px] bg-emerald-200/50 px-3 py-1 rounded-full uppercase font-black tracking-widest">Actif</span>
          </div>
        ) : (
          <div className="bg-slate-50 border border-slate-100 p-6 rounded-xl flex flex-col md:flex-row items-center justify-between gap-6">
            <div className="space-y-1">
              <p className="text-sm font-bold text-slate-800">Activez les paiements</p>
              <p className="text-xs text-slate-500 max-w-md">Connectez Stripe pour vendre des billets et encaisser des cotisations.</p>
            </div>
            <form action={createStripeConnectAccount.bind(null, org_slug)}>
              <button type="submit" className="bg-[#635BFF] text-white px-6 py-2.5 rounded-xl font-bold hover:bg-[#5851E3] transition shadow-md text-sm whitespace-nowrap">
                Connecter Stripe
              </button>
            </form>
          </div>
        )}
      </section>

      {/* --- GRID PRINCIPALE (LAYOUT 1/3 - 2/3) --- */}
      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        {/* --- COLONNE GAUCHE : AUTOMATISATION (4/12) --- */}
        <div className="lg:col-span-4 space-y-8">
            
            {/* Classification IA */}
            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                <div className="flex items-center gap-2 text-slate-800">
                    <Sparkles className="w-4 h-4 text-indigo-500" />
                    <h2 className="font-bold text-sm uppercase tracking-wide">Classification IA</h2>
                </div>
                <p className="text-xs text-slate-500 leading-relaxed">
                    Synchronisez vos catÃ©gories avec le moteur vectoriel pour permettre Ã  l'IA de reconnaÃ®tre automatiquement vos tickets.
                </p>
                <AiSyncButton />
            </div>

            {/* RÃ¨gles MÃ©tier */}
            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                <div className="flex items-center gap-2 text-slate-800">
                    <Gavel className="w-4 h-4 text-emerald-500" />
                    <h2 className="font-bold text-sm uppercase tracking-wide">RÃ¨gles MÃ©tier</h2>
                </div>
                <p className="text-xs text-slate-500 leading-relaxed">
                    DÃ©finissez des rÃ¨gles strictes (ex: "Uber" = Transport) pour contourner l'IA et garantir une prÃ©cision de 100%.
                </p>
                <RuleManager 
                    categories={flatCategories || []} 
                    initialRules={rules || []} 
                    orgSlug={org_slug} 
                />
            </div>
        </div>

        {/* --- COLONNE DROITE : PLAN COMPTABLE (8/12) --- */}
        <div className="lg:col-span-8">
            <section className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden h-full flex flex-col">
                <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div className="flex items-center gap-3">
                        <div className="p-2 bg-amber-50 text-amber-600 rounded-lg">
                            <FolderTree className="w-5 h-5" />
                        </div>
                        <div>
                            <h2 className="font-bold text-lg text-slate-800">Plan Comptable</h2>
                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-tight">Taxonomie HiÃ©rarchique</p>
                        </div>
                    </div>
                    {/* Le bouton d'ajout est gÃ©rÃ© Ã  l'intÃ©rieur du composant CategoryList */}
                </div>

                <div className="p-6 flex-1">
                    <CategoryList initialData={categoryTree} orgSlug={org_slug} />
                    
                    <div className="mt-8 pt-4 border-t flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
                            <span className="text-[9px] text-slate-400 font-mono font-bold uppercase tracking-widest">Live Sync Active</span>
                        </div>
                        <span className="text-[9px] text-slate-300 font-mono font-bold uppercase">{categoryTree.length} Nodes Loaded</span>
                    </div>
                </div>
            </section>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/[org_slug]/layout.tsx">
import Link from "next/link";

export default async function DashboardLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: Promise<{ org_slug: string }>;
}) {
  // 1. On attend les paramÃ¨tres
  const resolvedParams = await params;
  const org_slug = resolvedParams?.org_slug;

  // 2. SÃ©curitÃ© : si org_slug est absent, on ne rend pas des liens cassÃ©s
  if (!org_slug) {
    return <>{children}</>;
  }

  return (
    <div className="flex min-h-screen bg-slate-50">
      <aside className="hidden w-64 flex-col border-r bg-white md:flex">
        <div className="flex h-16 items-center border-b px-6 font-bold text-xl">
          Fintech Asso ğŸ’¸
        </div>
        <nav className="flex-1 space-y-1 p-4">
          <Link 
            href={`/${org_slug}`} 
            className="flex items-center gap-3 rounded-lg px-3 py-2 text-gray-500 hover:bg-slate-100 hover:text-gray-900"
          >
            ğŸ“Š Vue d'ensemble
          </Link>
          
          <Link 
            href={`/${org_slug}/budget`} 
            className="flex items-center gap-3 rounded-lg px-3 py-2 text-gray-500 hover:bg-slate-100 hover:text-gray-900"
          >
            ğŸ’° Budget & TrÃ©so
          </Link>
          
          <Link 
            href={`/${org_slug}/members`} 
            className="flex items-center gap-3 rounded-lg px-3 py-2 text-gray-500 hover:bg-slate-100 hover:text-gray-900"
          >
            ğŸ‘¥ Membres
          </Link>
          
          <Link 
            href={`/${org_slug}/settings`} 
            className="flex items-center gap-3 rounded-lg px-3 py-2 text-gray-500 hover:bg-slate-100 hover:text-gray-900"
          >
            âš™ï¸ ParamÃ¨tres
          </Link>
        </nav>
      </aside>

      <main className="flex-1">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="src/app/(marketing)/page.tsx">
import Link from "next/link";

export default function Home() {
  return (
    <main className="flex min-h-screen flex-col items-center justify-center p-24 bg-slate-50">
      <div className="text-center">
        <h1 className="text-5xl font-extrabold text-slate-900 tracking-tight">
          Projet B Fintech ğŸš€
        </h1>
        <p className="mt-4 text-xl text-slate-600">
          La plateforme de gestion financiÃ¨re pour l'ESIEE.
        </p>
        <div className="mt-8">
          <Link 
            href="/login" 
            className="rounded-md bg-blue-600 px-6 py-3 text-white font-semibold hover:bg-blue-700 transition"
          >
            AccÃ©der Ã  l'Espace TrÃ©sorier
          </Link>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="src/app/actions/get-receipt-url.ts">
'use server';

import { createClient } from "@/lib/supabase-server";

export async function getReceiptUrl(filePath: string) {
  const supabase = await createClient();

  // On demande une URL signÃ©e valide pour 60 minutes
  const { data, error } = await supabase
    .storage
    .from('receipts')
    .createSignedUrl(filePath, 3600);

  if (error || !data) {
    console.error("Erreur gÃ©nÃ©ration URL signÃ©e:", error);
    return null;
  }

  return data.signedUrl;
}
</file>

<file path="src/app/actions/scan-receipt.ts">
'use server';

import { createClient } from "@/lib/supabase-server";
import OpenAI from "openai";

// On enlÃ¨ve les imports Zod spÃ©cifiques Ã  la beta pour Ã©viter les erreurs
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function scanReceipt(formData: FormData) {
  const file = formData.get('file') as File;
  if (!file) throw new Error("Aucun fichier trouvÃ©");

  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("Non authentifiÃ©");

  // 1. Upload de l'image
  const filePath = `${user.id}/${Date.now()}-${file.name}`;
  const { error: uploadError } = await supabase.storage
    .from('receipts')
    .upload(filePath, file);

  if (uploadError) throw new Error("Erreur upload: " + uploadError.message);

  // 2. URL temporaire
  const { data: signedUrlData } = await supabase.storage
    .from('receipts')
    .createSignedUrl(filePath, 60);

  if (!signedUrlData) throw new Error("Erreur gÃ©nÃ©ration URL");

  // 3. Appel GPT-4o (Mode JSON Standard - Compatible toutes versions)
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o", 
      messages: [
        {
          role: "system",
          content: `Tu es un expert-comptable. Analyse ce ticket.
          RÃ©ponds UNIQUEMENT avec un objet JSON valide (pas de markdown, pas de texte avant/aprÃ¨s).
          
          Structure attendue :
          {
            "date": "YYYY-MM-DD",
            "amount": 0.00 (nombre),
            "description": "Nom du commerÃ§ant + objet",
            "category": "Une catÃ©gorie parmi: Alimentation, Transport, MatÃ©riel, Prestation, Cotisation, Autre"
          }
          
          Si une info est illisible, mets null ou 0.`
        },
        {
          role: "user",
          content: [
            { type: "text", text: "Extrais les donnÃ©es :" },
            { type: "image_url", image_url: { url: signedUrlData.signedUrl } },
          ],
        },
      ],
      // C'est Ã§a l'astuce : on force le mode JSON natif sans passer par la beta
      response_format: { type: "json_object" }, 
      max_tokens: 300,
    });

    const content = response.choices[0].message.content;
    
    if (!content) throw new Error("RÃ©ponse vide de l'IA");

    const result = JSON.parse(content);

    // 4. On renvoie les donnÃ©es + le chemin
    return {
      success: true,
      amount: result.amount,
      date: result.date,
      description: result.description,
      category: result.category,
      receipt_path: filePath, 
    };

  } catch (error: any) {
    console.error("Erreur OpenAI:", error);
    return { error: "Lecture impossible: " + error.message };
  }
}
</file>

<file path="src/components/charts/cashflow-chart.tsx">
"use client";

import { Bar, BarChart, CartesianGrid, XAxis } from "recharts";
import { 
  ChartContainer, 
  ChartTooltip, 
  ChartTooltipContent,
  type ChartConfig 
} from "@/components/ui/chart";

export function CashflowChart({ data }: { data: any[] }) {
  // Configuration des couleurs (Shadcn UI Chart)
  const chartConfig = {
    income: {
      label: "EntrÃ©es",
      color: "#10b981", // Emerald 500
    },
    expense: {
      label: "Sorties",
      color: "#ef4444", // Red 500
    },
  } satisfies ChartConfig;

  if (!data || data.length === 0) {
    return (
      <div className="h-[300px] w-full flex items-center justify-center border border-dashed rounded-xl bg-slate-50">
        <p className="text-slate-400 text-sm">Pas assez de donnÃ©es</p>
      </div>
    );
  }

  return (
    <div className="h-[300px] w-full">
      <ChartContainer config={chartConfig} className="h-full w-full">
        <BarChart accessibilityLayer data={data}>
          <CartesianGrid vertical={false} strokeDasharray="3 3" stroke="#e5e7eb" />
          <XAxis
            dataKey="month"
            tickLine={false}
            tickMargin={10}
            axisLine={false}
            tickFormatter={(value) => value.slice(0, 3)} // Jan, Fev...
          />
          <ChartTooltip content={<ChartTooltipContent indicator="dot" />} />
          <Bar 
            dataKey="income" 
            fill="var(--color-income)" 
            radius={[4, 4, 0, 0]} 
            name="Recettes" 
          />
          <Bar 
            dataKey="expense" 
            fill="var(--color-expense)" 
            radius={[4, 4, 0, 0]} 
            name="DÃ©penses" 
          />
        </BarChart>
      </ChartContainer>
    </div>
  );
}
</file>

<file path="src/components/dashboard/event-card.tsx">
'use client';

import { Calendar, Tag } from "lucide-react";
import { createCheckoutSession } from "@/app/(dashboard)/[org_slug]/budget/actions"; 

interface EventProps {
  id: string;
  title: string;
  description: string;
  price: number; // en centimes
  date: string;
  org_slug: string;
}

export function EventCard({ event }: { event: EventProps }) {
  const priceInEur = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(event.price / 100);

  return (
    <div className="bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:shadow-md transition flex flex-col justify-between h-full">
      <div>
        <div className="flex justify-between items-start mb-2">
          <h3 className="font-bold text-slate-900">{event.title}</h3>
          <span className="bg-emerald-50 text-emerald-700 text-xs font-bold px-2 py-1 rounded-full">
            {priceInEur}
          </span>
        </div>
        <p className="text-slate-500 text-sm mb-4 line-clamp-2">{event.description}</p>
        
        <div className="flex items-center gap-4 text-xs text-slate-400 mb-6">
          <div className="flex items-center gap-1">
            <Calendar className="w-3 h-3" />
            {/* âœ… CORRECTION ICI : On force le format FR et on ignore l'erreur d'hydratation */}
            <span suppressHydrationWarning>
              {new Date(event.date).toLocaleDateString('fr-FR')}
            </span>
          </div>
          <div className="flex items-center gap-1">
            <Tag className="w-3 h-3" />
            Billetterie
          </div>
        </div>
      </div>

      <button 
        onClick={() => createCheckoutSession(event.org_slug, event.price / 100, event.title)}
        className="w-full bg-slate-900 text-white py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition active:scale-95"
      >
        Acheter le billet
      </button>
    </div>
  );
}
</file>

<file path="src/components/dashboard/transaction-detail-sheet.tsx">
'use client';

import { useState } from "react";
import { 
  Sheet, 
  SheetContent, 
  SheetHeader, 
  SheetTitle, 
  SheetTrigger 
} from "@/components/ui/sheet";
import { getReceiptUrl } from "@/app/actions/get-receipt-url";
import { FileText, Loader2, ExternalLink } from "lucide-react";
import Image from "next/image";

// Formatteur pour transformer les centimes en Euros propres
const formatCurrency = (amountInCents: number) => {
  return new Intl.NumberFormat("fr-FR", {
    style: "currency",
    currency: "EUR",
  }).format(amountInCents / 100);
};

export function TransactionDetailSheet({ transaction }: { transaction: any }) {
  const [imageUrl, setImageUrl] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const loadReceipt = async () => {
    if (!transaction.receipt_url || imageUrl) return;
    setLoading(true);
    const url = await getReceiptUrl(transaction.receipt_url);
    setImageUrl(url);
    setLoading(false);
  };

  return (
    <Sheet onOpenChange={(open) => open && loadReceipt()}>
      <SheetTrigger asChild>
        <button className="p-2 hover:bg-slate-100 rounded-full transition text-slate-500">
          <FileText className="w-4 h-4" />
        </button>
      </SheetTrigger>
      <SheetContent className="sm:max-w-xl overflow-y-auto">
        <SheetHeader>
          <SheetTitle className="text-xl">DÃ©tail de la transaction</SheetTitle>
        </SheetHeader>

        <div className="mt-8 space-y-6">
          {/* Info Transaction */}
          <div className="grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg border border-slate-100">
            <div>
              <p className="text-xs text-slate-500 uppercase font-semibold">Montant</p>
              <p className={`text-lg font-bold ${transaction.type === 'expense' ? 'text-red-600' : 'text-emerald-600'}`}>
                {/* âœ… Correction : Division par 100 + formatage propre */}
                {transaction.type === 'expense' ? '-' : '+'}
                {formatCurrency(transaction.amount)}
              </p>
            </div>
            <div>
              <p className="text-xs text-slate-500 uppercase font-semibold">Date</p>
              <p className="font-medium">{new Date(transaction.date).toLocaleDateString('fr-FR')}</p>
            </div>
          </div>

          {/* Justificatif */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <h3 className="font-semibold text-slate-800">Justificatif</h3>
              {imageUrl && (
                <a href={imageUrl} target="_blank" rel="noreferrer" className="text-xs text-blue-600 flex items-center gap-1 hover:underline">
                  Ouvrir en grand <ExternalLink className="w-3 h-3" />
                </a>
              )}
            </div>

            <div className="relative aspect-[3/4] w-full bg-slate-100 rounded-xl border-2 border-dashed border-slate-200 overflow-hidden flex items-center justify-center">
              {loading ? (
                <Loader2 className="w-8 h-8 animate-spin text-slate-400" />
              ) : imageUrl ? (
                <Image 
                  src={imageUrl} 
                  alt="Ticket de caisse" 
                  fill 
                  className="object-contain p-2"
                />
              ) : (
                <p className="text-sm text-slate-400">Aucun justificatif liÃ©</p>
              )}
            </div>
          </div>

          {/* Analyse IA Recap */}
          <div className="space-y-3">
             <h3 className="font-semibold text-slate-800">Informations comptables</h3>
             <div className="space-y-2">
                <div className="flex justify-between text-sm border-b pb-2">
                    <span className="text-slate-500">Description</span>
                    <span className="font-medium">{transaction.description || "Aucune description"}</span>
                </div>
                <div className="flex justify-between text-sm border-b pb-2">
                    <span className="text-slate-500">CatÃ©gorie</span>
                    <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-medium">
                        {transaction.category || "Non classÃ©"}
                    </span>
                </div>
             </div>
          </div>
        </div>
      </SheetContent>
    </Sheet>
  );
}
</file>

<file path="src/components/forms/receipt-uploader.tsx">
'use client';

import { useState, useCallback } from 'react';
import { UploadCloud, Loader2, CheckCircle, FileText } from 'lucide-react';
import { scanReceipt } from '@/app/actions/scan-receipt';

interface ReceiptUploaderProps {
  onScanComplete: (data: any) => void;
}

export function ReceiptUploader({ onScanComplete }: ReceiptUploaderProps) {
  const [isDragging, setIsDragging] = useState(false);
  const [isScanning, setIsScanning] = useState(false);
  const [preview, setPreview] = useState<string | null>(null);

  const handleFile = async (file: File) => {
    // AperÃ§u immÃ©diat
    const objectUrl = URL.createObjectURL(file);
    setPreview(objectUrl);
    setIsScanning(true);

    // PrÃ©paration de l'envoi
    const formData = new FormData();
    formData.append('file', file);

    try {
      // Appel Server Action
      const data = await scanReceipt(formData);
      
      if (data && !data.error) {

        onScanComplete(data); 
      } else {
        alert("Erreur lecture: " + data.error);
      }
    } catch (e) {
      console.error(e);
      alert("Erreur lors de l'envoi");
    } finally {
      setIsScanning(false);
    }
  };

  return (
    <div className="mb-6">
      <label className="block text-sm font-medium text-slate-700 mb-2">Justificatif (Scan IA)</label>
      
      <div
        className={`relative border-2 border-dashed rounded-xl p-6 transition-all text-center cursor-pointer ${
          isDragging ? 'border-blue-500 bg-blue-50' : 'border-slate-300 hover:border-slate-400 hover:bg-slate-50'
        } ${preview ? 'bg-emerald-50 border-emerald-200' : ''}`}
        onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
        onDragLeave={() => setIsDragging(false)}
        onDrop={(e) => {
          e.preventDefault();
          setIsDragging(false);
          if (e.dataTransfer.files?.[0]) handleFile(e.dataTransfer.files[0]);
        }}
      >
        <input 
          type="file" 
          accept="image/*" 
          className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
          onChange={(e) => e.target.files?.[0] && handleFile(e.target.files[0])}
        />

        <div className="flex flex-col items-center justify-center gap-2">
          {isScanning ? (
            <>
              <Loader2 className="w-8 h-8 text-blue-600 animate-spin" />
              <p className="text-sm font-medium text-blue-600">L'IA analyse votre ticket...</p>
            </>
          ) : preview ? (
            <>
              <CheckCircle className="w-8 h-8 text-emerald-600" />
              <p className="text-sm font-medium text-emerald-800">Analyse terminÃ©e !</p>
              <p className="text-xs text-emerald-600">Les champs ont Ã©tÃ© remplis.</p>
            </>
          ) : (
            <>
              <div className="p-3 bg-white rounded-full shadow-sm">
                <UploadCloud className="w-6 h-6 text-slate-400" />
              </div>
              <div>
                <p className="text-sm font-medium text-slate-700">Cliquez ou glissez un ticket ici</p>
                <p className="text-xs text-slate-500">JPG, PNG jusqu'Ã  5MB</p>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
</file>

<file path="src/components/ui/chart.tsx">
"use client"

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

function ChartContainer({
  id,
  className,
  children,
  config,
  ...props
}: React.ComponentProps<"div"> & {
  config: ChartConfig
  children: React.ComponentProps<
    typeof RechartsPrimitive.ResponsiveContainer
  >["children"]
}) {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-slot="chart"
        data-chart={chartId}
        className={cn(
          "[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
}

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

function ChartTooltipContent({
  active,
  payload,
  className,
  indicator = "dot",
  hideLabel = false,
  hideIndicator = false,
  label,
  labelFormatter,
  labelClassName,
  formatter,
  color,
  nameKey,
  labelKey,
}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
  React.ComponentProps<"div"> & {
    hideLabel?: boolean
    hideIndicator?: boolean
    indicator?: "line" | "dot" | "dashed"
    nameKey?: string
    labelKey?: string
  }) {
  const { config } = useChart()

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null
    }

    const [item] = payload
    const key = `${labelKey || item?.dataKey || item?.name || "value"}`
    const itemConfig = getPayloadConfigFromPayload(config, item, key)
    const value =
      !labelKey && typeof label === "string"
        ? config[label as keyof typeof config]?.label || label
        : itemConfig?.label

    if (labelFormatter) {
      return (
        <div className={cn("font-medium", labelClassName)}>
          {labelFormatter(value, payload)}
        </div>
      )
    }

    if (!value) {
      return null
    }

    return <div className={cn("font-medium", labelClassName)}>{value}</div>
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ])

  if (!active || !payload?.length) {
    return null
  }

  const nestLabel = payload.length === 1 && indicator !== "dot"

  return (
    <div
      className={cn(
        "border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl",
        className
      )}
    >
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload
          .filter((item) => item.type !== "none")
          .map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="text-foreground font-mono font-medium tabular-nums">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
      </div>
    </div>
  )
}

const ChartLegend = RechartsPrimitive.Legend

function ChartLegendContent({
  className,
  hideIcon = false,
  payload,
  verticalAlign = "bottom",
  nameKey,
}: React.ComponentProps<"div"> &
  Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
    hideIcon?: boolean
    nameKey?: string
  }) {
  const { config } = useChart()

  if (!payload?.length) {
    return null
  }

  return (
    <div
      className={cn(
        "flex items-center justify-center gap-4",
        verticalAlign === "top" ? "pb-3" : "pt-3",
        className
      )}
    >
      {payload
        .filter((item) => item.type !== "none")
        .map((item) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
    </div>
  )
}

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}
</file>

<file path="src/components/ui/sheet.tsx">
"use client"

import * as React from "react"
import { XIcon } from "lucide-react"
import { Dialog as SheetPrimitive } from "radix-ui"

import { cn } from "@/lib/utils"

function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
  return <SheetPrimitive.Root data-slot="sheet" {...props} />
}

function SheetTrigger({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
  return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />
}

function SheetClose({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Close>) {
  return <SheetPrimitive.Close data-slot="sheet-close" {...props} />
}

function SheetPortal({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Portal>) {
  return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />
}

function SheetOverlay({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
  return (
    <SheetPrimitive.Overlay
      data-slot="sheet-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function SheetContent({
  className,
  children,
  side = "right",
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Content> & {
  side?: "top" | "right" | "bottom" | "left"
  showCloseButton?: boolean
}) {
  return (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content
        data-slot="sheet-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
          side === "right" &&
            "data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",
          side === "left" &&
            "data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",
          side === "top" &&
            "data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",
          side === "bottom" &&
            "data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",
          className
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
            <XIcon className="size-4" />
            <span className="sr-only">Close</span>
          </SheetPrimitive.Close>
        )}
      </SheetPrimitive.Content>
    </SheetPortal>
  )
}

function SheetHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-header"
      className={cn("flex flex-col gap-1.5 p-4", className)}
      {...props}
    />
  )
}

function SheetFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  )
}

function SheetTitle({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Title>) {
  return (
    <SheetPrimitive.Title
      data-slot="sheet-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  )
}

function SheetDescription({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Description>) {
  return (
    <SheetPrimitive.Description
      data-slot="sheet-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="src/lib/supabase-middleware.ts">
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))
          response = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  await supabase.auth.getUser()

  return response
}
</file>

<file path="src/lib/supabase-server.ts">
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // Ignorer si appelÃ© depuis un Server Component
          }
        },
      },
    }
  );
}
</file>

<file path="src/lib/supabase.ts">

</file>

<file path="src/middleware.ts">
import { type NextRequest } from 'next/server'
import { updateSession } from '@/lib/supabase-middleware' // On crÃ©era ce fichier juste aprÃ¨s

export async function middleware(request: NextRequest) {
  // Pour l'instant, on laisse passer tout le monde le temps de configurer
  // return await updateSession(request)
  return; 
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
</file>

<file path="supabase/.temp/cli-latest">
v2.75.0
</file>

<file path="supabase/.temp/gotrue-version">
v2.186.0
</file>

<file path="supabase/.temp/pooler-url">
postgresql://postgres.jwogrpkuzmjmabkpsyrd@aws-1-eu-west-1.pooler.supabase.com:5432/postgres
</file>

<file path="supabase/.temp/postgres-version">
17.6.1.063
</file>

<file path="supabase/.temp/project-ref">
jwogrpkuzmjmabkpsyrd
</file>

<file path="supabase/.temp/rest-version">
v14.1
</file>

<file path="supabase/.temp/storage-migration">
buckets-objects-grants-postgres
</file>

<file path="supabase/.temp/storage-version">
v1.33.0
</file>

<file path="supabase/config.toml">
# For detailed configuration reference documentation, visit:
# https://supabase.com/docs/guides/local-development/cli/config
# A string used to distinguish different Supabase projects on the same host. Defaults to the
# working directory name when running `supabase init`.
project_id = "projet-asso-fintech"

[api]
enabled = true
# Port to use for the API URL.
port = 54321
# Schemas to expose in your API. Tables, views and stored procedures in this schema will get API
# endpoints. `public` and `graphql_public` schemas are included by default.
schemas = ["public", "graphql_public"]
# Extra schemas to add to the search_path of every request.
extra_search_path = ["public", "extensions"]
# The maximum number of rows returns from a view, table, or stored procedure. Limits payload size
# for accidental or malicious requests.
max_rows = 1000

[api.tls]
# Enable HTTPS endpoints locally using a self-signed certificate.
enabled = false
# Paths to self-signed certificate pair.
# cert_path = "../certs/my-cert.pem"
# key_path = "../certs/my-key.pem"

[db]
# Port to use for the local database URL.
port = 54322
# Port used by db diff command to initialize the shadow database.
shadow_port = 54320
# Maximum amount of time to wait for health check when starting the local database.
health_timeout = "2m"
# The database major version to use. This has to be the same as your remote database's. Run `SHOW
# server_version;` on the remote database to check.
major_version = 17

[db.pooler]
enabled = false
# Port to use for the local connection pooler.
port = 54329
# Specifies when a server connection can be reused by other clients.
# Configure one of the supported pooler modes: `transaction`, `session`.
pool_mode = "transaction"
# How many server connections to allow per user/database pair.
default_pool_size = 20
# Maximum number of client connections allowed.
max_client_conn = 100

# [db.vault]
# secret_key = "env(SECRET_VALUE)"

[db.migrations]
# If disabled, migrations will be skipped during a db push or reset.
enabled = true
# Specifies an ordered list of schema files that describe your database.
# Supports glob patterns relative to supabase directory: "./schemas/*.sql"
schema_paths = []

[db.seed]
# If enabled, seeds the database after migrations during a db reset.
enabled = true
# Specifies an ordered list of seed files to load during db reset.
# Supports glob patterns relative to supabase directory: "./seeds/*.sql"
sql_paths = ["./seed.sql"]

[db.network_restrictions]
# Enable management of network restrictions.
enabled = false
# List of IPv4 CIDR blocks allowed to connect to the database.
# Defaults to allow all IPv4 connections. Set empty array to block all IPs.
allowed_cidrs = ["0.0.0.0/0"]
# List of IPv6 CIDR blocks allowed to connect to the database.
# Defaults to allow all IPv6 connections. Set empty array to block all IPs.
allowed_cidrs_v6 = ["::/0"]

[realtime]
enabled = true
# Bind realtime via either IPv4 or IPv6. (default: IPv4)
# ip_version = "IPv6"
# The maximum length in bytes of HTTP request headers. (default: 4096)
# max_header_length = 4096

[studio]
enabled = true
# Port to use for Supabase Studio.
port = 54323
# External URL of the API server that frontend connects to.
api_url = "http://127.0.0.1"
# OpenAI API Key to use for Supabase AI in the Supabase Studio.
openai_api_key = "env(OPENAI_API_KEY)"

# Email testing server. Emails sent with the local dev setup are not actually sent - rather, they
# are monitored, and you can view the emails that would have been sent from the web interface.
[inbucket]
enabled = true
# Port to use for the email testing server web interface.
port = 54324
# Uncomment to expose additional ports for testing user applications that send emails.
# smtp_port = 54325
# pop3_port = 54326
# admin_email = "admin@email.com"
# sender_name = "Admin"

[storage]
enabled = true
# The maximum file size allowed (e.g. "5MB", "500KB").
file_size_limit = "50MiB"

# Uncomment to configure local storage buckets
# [storage.buckets.images]
# public = false
# file_size_limit = "50MiB"
# allowed_mime_types = ["image/png", "image/jpeg"]
# objects_path = "./images"

# Allow connections via S3 compatible clients
[storage.s3_protocol]
enabled = true

# Image transformation API is available to Supabase Pro plan.
# [storage.image_transformation]
# enabled = true

# Store analytical data in S3 for running ETL jobs over Iceberg Catalog
# This feature is only available on the hosted platform.
[storage.analytics]
enabled = false
max_namespaces = 5
max_tables = 10
max_catalogs = 2

# Analytics Buckets is available to Supabase Pro plan.
# [storage.analytics.buckets.my-warehouse]

# Store vector embeddings in S3 for large and durable datasets
# This feature is only available on the hosted platform.
[storage.vector]
enabled = false
max_buckets = 10
max_indexes = 5

# Vector Buckets is available to Supabase Pro plan.
# [storage.vector.buckets.documents-openai]

[auth]
enabled = true
# The base URL of your website. Used as an allow-list for redirects and for constructing URLs used
# in emails.
site_url = "http://127.0.0.1:3000"
# A list of *exact* URLs that auth providers are permitted to redirect to post authentication.
additional_redirect_urls = ["https://127.0.0.1:3000"]
# How long tokens are valid for, in seconds. Defaults to 3600 (1 hour), maximum 604,800 (1 week).
jwt_expiry = 3600
# JWT issuer URL. If not set, defaults to the local API URL (http://127.0.0.1:<port>/auth/v1).
# jwt_issuer = ""
# Path to JWT signing key. DO NOT commit your signing keys file to git.
# signing_keys_path = "./signing_keys.json"
# If disabled, the refresh token will never expire.
enable_refresh_token_rotation = true
# Allows refresh tokens to be reused after expiry, up to the specified interval in seconds.
# Requires enable_refresh_token_rotation = true.
refresh_token_reuse_interval = 10
# Allow/disallow new user signups to your project.
enable_signup = true
# Allow/disallow anonymous sign-ins to your project.
enable_anonymous_sign_ins = false
# Allow/disallow testing manual linking of accounts
enable_manual_linking = false
# Passwords shorter than this value will be rejected as weak. Minimum 6, recommended 8 or more.
minimum_password_length = 6
# Passwords that do not meet the following requirements will be rejected as weak. Supported values
# are: `letters_digits`, `lower_upper_letters_digits`, `lower_upper_letters_digits_symbols`
password_requirements = ""

[auth.rate_limit]
# Number of emails that can be sent per hour. Requires auth.email.smtp to be enabled.
email_sent = 2
# Number of SMS messages that can be sent per hour. Requires auth.sms to be enabled.
sms_sent = 30
# Number of anonymous sign-ins that can be made per hour per IP address. Requires enable_anonymous_sign_ins = true.
anonymous_users = 30
# Number of sessions that can be refreshed in a 5 minute interval per IP address.
token_refresh = 150
# Number of sign up and sign-in requests that can be made in a 5 minute interval per IP address (excludes anonymous users).
sign_in_sign_ups = 30
# Number of OTP / Magic link verifications that can be made in a 5 minute interval per IP address.
token_verifications = 30
# Number of Web3 logins that can be made in a 5 minute interval per IP address.
web3 = 30

# Configure one of the supported captcha providers: `hcaptcha`, `turnstile`.
# [auth.captcha]
# enabled = true
# provider = "hcaptcha"
# secret = ""

[auth.email]
# Allow/disallow new user signups via email to your project.
enable_signup = true
# If enabled, a user will be required to confirm any email change on both the old, and new email
# addresses. If disabled, only the new email is required to confirm.
double_confirm_changes = true
# If enabled, users need to confirm their email address before signing in.
enable_confirmations = false
# If enabled, users will need to reauthenticate or have logged in recently to change their password.
secure_password_change = false
# Controls the minimum amount of time that must pass before sending another signup confirmation or password reset email.
max_frequency = "1s"
# Number of characters used in the email OTP.
otp_length = 6
# Number of seconds before the email OTP expires (defaults to 1 hour).
otp_expiry = 3600

# Use a production-ready SMTP server
# [auth.email.smtp]
# enabled = true
# host = "smtp.sendgrid.net"
# port = 587
# user = "apikey"
# pass = "env(SENDGRID_API_KEY)"
# admin_email = "admin@email.com"
# sender_name = "Admin"

# Uncomment to customize email template
# [auth.email.template.invite]
# subject = "You have been invited"
# content_path = "./supabase/templates/invite.html"

# Uncomment to customize notification email template
# [auth.email.notification.password_changed]
# enabled = true
# subject = "Your password has been changed"
# content_path = "./templates/password_changed_notification.html"

[auth.sms]
# Allow/disallow new user signups via SMS to your project.
enable_signup = false
# If enabled, users need to confirm their phone number before signing in.
enable_confirmations = false
# Template for sending OTP to users
template = "Your code is {{ .Code }}"
# Controls the minimum amount of time that must pass before sending another sms otp.
max_frequency = "5s"

# Use pre-defined map of phone number to OTP for testing.
# [auth.sms.test_otp]
# 4152127777 = "123456"

# Configure logged in session timeouts.
# [auth.sessions]
# Force log out after the specified duration.
# timebox = "24h"
# Force log out if the user has been inactive longer than the specified duration.
# inactivity_timeout = "8h"

# This hook runs before a new user is created and allows developers to reject the request based on the incoming user object.
# [auth.hook.before_user_created]
# enabled = true
# uri = "pg-functions://postgres/auth/before-user-created-hook"

# This hook runs before a token is issued and allows you to add additional claims based on the authentication method used.
# [auth.hook.custom_access_token]
# enabled = true
# uri = "pg-functions://<database>/<schema>/<hook_name>"

# Configure one of the supported SMS providers: `twilio`, `twilio_verify`, `messagebird`, `textlocal`, `vonage`.
[auth.sms.twilio]
enabled = false
account_sid = ""
message_service_sid = ""
# DO NOT commit your Twilio auth token to git. Use environment variable substitution instead:
auth_token = "env(SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN)"

# Multi-factor-authentication is available to Supabase Pro plan.
[auth.mfa]
# Control how many MFA factors can be enrolled at once per user.
max_enrolled_factors = 10

# Control MFA via App Authenticator (TOTP)
[auth.mfa.totp]
enroll_enabled = false
verify_enabled = false

# Configure MFA via Phone Messaging
[auth.mfa.phone]
enroll_enabled = false
verify_enabled = false
otp_length = 6
template = "Your code is {{ .Code }}"
max_frequency = "5s"

# Configure MFA via WebAuthn
# [auth.mfa.web_authn]
# enroll_enabled = true
# verify_enabled = true

# Use an external OAuth provider. The full list of providers are: `apple`, `azure`, `bitbucket`,
# `discord`, `facebook`, `github`, `gitlab`, `google`, `keycloak`, `linkedin_oidc`, `notion`, `twitch`,
# `twitter`, `x`, `slack`, `spotify`, `workos`, `zoom`.
[auth.external.apple]
enabled = false
client_id = ""
# DO NOT commit your OAuth provider secret to git. Use environment variable substitution instead:
secret = "env(SUPABASE_AUTH_EXTERNAL_APPLE_SECRET)"
# Overrides the default auth redirectUrl.
redirect_uri = ""
# Overrides the default auth provider URL. Used to support self-hosted gitlab, single-tenant Azure,
# or any other third-party OIDC providers.
url = ""
# If enabled, the nonce check will be skipped. Required for local sign in with Google auth.
skip_nonce_check = false
# If enabled, it will allow the user to successfully authenticate when the provider does not return an email address.
email_optional = false

# Allow Solana wallet holders to sign in to your project via the Sign in with Solana (SIWS, EIP-4361) standard.
# You can configure "web3" rate limit in the [auth.rate_limit] section and set up [auth.captcha] if self-hosting.
[auth.web3.solana]
enabled = false

# Use Firebase Auth as a third-party provider alongside Supabase Auth.
[auth.third_party.firebase]
enabled = false
# project_id = "my-firebase-project"

# Use Auth0 as a third-party provider alongside Supabase Auth.
[auth.third_party.auth0]
enabled = false
# tenant = "my-auth0-tenant"
# tenant_region = "us"

# Use AWS Cognito (Amplify) as a third-party provider alongside Supabase Auth.
[auth.third_party.aws_cognito]
enabled = false
# user_pool_id = "my-user-pool-id"
# user_pool_region = "us-east-1"

# Use Clerk as a third-party provider alongside Supabase Auth.
[auth.third_party.clerk]
enabled = false
# Obtain from https://clerk.com/setup/supabase
# domain = "example.clerk.accounts.dev"

# OAuth server configuration
[auth.oauth_server]
# Enable OAuth server functionality
enabled = false
# Path for OAuth consent flow UI
authorization_url_path = "/oauth/consent"
# Allow dynamic client registration
allow_dynamic_registration = false

[edge_runtime]
enabled = true
# Supported request policies: `oneshot`, `per_worker`.
# `per_worker` (default) â€” enables hot reload during local development.
# `oneshot` â€” fallback mode if hot reload causes issues (e.g. in large repos or with symlinks).
policy = "per_worker"
# Port to attach the Chrome inspector for debugging edge functions.
inspector_port = 8083
# The Deno major version to use.
deno_version = 2

# [edge_runtime.secrets]
# secret_key = "env(SECRET_VALUE)"

[analytics]
enabled = true
port = 54327
# Configure one of the supported backends: `postgres`, `bigquery`.
backend = "postgres"

# Experimental features may be deprecated any time
[experimental]
# Configures Postgres storage engine to use OrioleDB (S3)
orioledb_version = ""
# Configures S3 bucket URL, eg. <bucket_name>.s3-<region>.amazonaws.com
s3_host = "env(S3_HOST)"
# Configures S3 bucket region, eg. us-east-1
s3_region = "env(S3_REGION)"
# Configures AWS_ACCESS_KEY_ID for S3 bucket
s3_access_key = "env(S3_ACCESS_KEY)"
# Configures AWS_SECRET_ACCESS_KEY for S3 bucket
s3_secret_key = "env(S3_SECRET_KEY)"
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "zinc",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "rtl": false,
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="deploy.sql">

</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      backgroundImage: {
        "gradient-radial": "radial-gradient(var(--tw-gradient-stops))",
        "gradient-conic":
          "conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))",
      },
    },
  },
  plugins: [],
};
export default config;
</file>

<file path="src/app/(auth)/login/actions.ts">
"use server";

import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase-server";

// --- FONCTION DE CONNEXION ---
export async function login(formData: FormData) {
  const supabase = await createClient();

  const email = formData.get("email") as string;
  const password = formData.get("password") as string;

  // 1. Connexion Supabase
  const { error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  if (error) {
    return redirect("/login?error=true");
  }

  // 2. Qui est connectÃ© ?
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return redirect("/login");

  console.log("ğŸ‘¤ Utilisateur connectÃ© :", user.email);

  // 3. REQUÃŠTE PLUS ROBUSTE (Sans .single())
  // On rÃ©cupÃ¨re toutes les adhÃ©sions possibles
  const { data: memberships, error: memberError } = await supabase
    .from("members")
    .select(`
      organization_id,
      organizations ( slug )
    `)
    .eq("user_id", user.id);

  // Mouchard pour voir ce que Supabase renvoie dans ton terminal
  console.log("ğŸ” RÃ©sultat recherche asso :", { 
    found: memberships?.length || 0, 
    firstResult: memberships?.[0],
    error: memberError 
  });

  // 4. ANALYSE DU RÃ‰SULTAT
  // On prend la premiÃ¨re asso trouvÃ©e (s'il y en a une)
  const firstMembership = memberships?.[0];

  if (firstMembership && firstMembership.organizations) {
    // Astuce : Parfois Supabase renvoie un tableau, parfois un objet selon la relation
    // On gÃ¨re les deux cas pour Ã©viter le crash
    const orgData = firstMembership.organizations;
    // @ts-ignore
    const slug = Array.isArray(orgData) ? orgData[0]?.slug : orgData?.slug;

    if (slug) {
      console.log("âœ… Redirection vers :", slug);
      revalidatePath(`/${slug}/budget`, "layout");
      redirect(`/${slug}/budget`);
    }
  }

  // 5. Si on arrive ici, c'est qu'aucune asso valide n'a Ã©tÃ© trouvÃ©e
  console.log("âš ï¸ Aucune asso trouvÃ©e -> Direction Onboarding");
  revalidatePath("/onboarding", "layout");
  redirect("/onboarding");
}

// --- FONCTION D'INSCRIPTION ---
export async function signup(formData: FormData) {
  const supabase = await createClient();
  
  const data = {
    email: formData.get("email") as string,
    password: formData.get("password") as string,
  };

  const { error } = await supabase.auth.signUp(data);

  if (error) {
    console.error("Erreur signup:", error);
    return redirect("/error");
  }

  revalidatePath("/", "layout");
  redirect("/onboarding");
}
</file>

<file path="src/app/(auth)/login/page.tsx">
import { login, signup } from "./actions";

export default function LoginPage() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <form className="w-full max-w-md space-y-4 rounded-lg bg-white p-8 shadow">
        <h2 className="text-2xl font-bold text-center">Connexion / Inscription</h2>
        
        <div className="flex flex-col gap-2">
          <label htmlFor="email">Email</label>
          <input id="email" name="email" type="email" required className="border p-2 rounded" />
        </div>
        
        <div className="flex flex-col gap-2">
          <label htmlFor="password">Mot de passe</label>
          <input id="password" name="password" type="password" required className="border p-2 rounded" />
        </div>

        <div className="flex gap-4 pt-4">
          <button formAction={login} className="flex-1 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
            Se connecter
          </button>
          <button formAction={signup} className="flex-1 bg-gray-200 text-gray-900 p-2 rounded hover:bg-gray-300">
            S'inscrire
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/[org_slug]/actions.ts">
'use server';

import { createClient } from "@/lib/supabase-server";
import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { z } from "zod";
import { categorizeTransaction } from "@/lib/ai";

// --- SchÃ©mas de Validation ---
const transactionSchema = z.object({
  description: z.string().min(2, "Description trop courte"),
  amount: z.coerce.number().positive("Le montant doit Ãªtre positif"),
  type: z.enum(["income", "expense"]),
  categoryName: z.string().optional(), 
  date: z.string(),
});

// --- 1. GESTION DES TRANSACTIONS ---

export async function getTransactions(slug: string) {
  const supabase = await createClient();
  const { data: org } = await supabase.from('organizations').select('id').eq('slug', slug).single();
  if (!org) return [];

  const { data, error } = await supabase
    .from('transactions')
    .select(`*, budget_categories ( name, color )`)
    .eq('organization_id', org.id)
    .order('date', { ascending: false });

  return data || [];
}

export async function createTransaction(formData: FormData) {
  const supabase = await createClient();
  const org_slug = formData.get("org_slug") as string;
  
  const rawData = {
    description: formData.get("description") as string,
    amount: formData.get("amount"),
    type: formData.get("type"),
    categoryName: formData.get("category") as string, 
    date: formData.get("date"),
    receipt_path: formData.get("receipt_path"),
  };

  const validatedFields = transactionSchema.safeParse(rawData);
  if (!validatedFields.success) throw new Error("DonnÃ©es invalides.");
  const { description, amount, type, categoryName, date } = validatedFields.data;

  const { data: org } = await supabase.from('organizations').select('id').eq('slug', org_slug).single();
  if (!org) throw new Error("Organisation introuvable");

  // --- ğŸ§  LOGIQUE DE DÃ‰CISION HIÃ‰RARCHIQUE ---
  let categoryId = null;
  let method: 'manual' | 'ai_llm' | 'ai_vector' | 'hard_rule' = 'manual';
  let status: 'pending' | 'ai_suggested' | 'validated' = 'pending';

  const { data: dbCategories } = await supabase
    .from('budget_categories')
    .select('id, name')
    .eq('organization_id', org.id);

  if (dbCategories && dbCategories.length > 0) {
    // Ã‰TAPE A : Match Exact (Manuel)
    const exactMatch = dbCategories.find(c => c.name.toLowerCase() === categoryName?.trim().toLowerCase());
    
    if (exactMatch) {
      categoryId = exactMatch.id;
      method = 'manual';
      status = 'validated';
    } 
    else {
      // Ã‰TAPE B : Moteur de RÃ¨gles DÃ©terministes (Hard Rules) âš™ï¸
      const { data: rules } = await supabase
        .from('budget_rules')
        .select('category_id, pattern')
        .eq('organization_id', org.id);

      const matchingRule = rules?.find(rule => 
        description.toLowerCase().includes(rule.pattern.toLowerCase())
      );

      if (matchingRule) {
        categoryId = matchingRule.category_id;
        method = 'hard_rule';
        status = 'validated'; // RÃ¨gle mÃ©tier = Auto-validÃ©
      } 
      else {
        // Ã‰TAPE C : Suggestion IA (Probabiliste) ğŸ¤–
        const availableNames = dbCategories.map(c => c.name);
        const aiSuggestedName = await categorizeTransaction(description, amount, availableNames);
        const matchedCategory = dbCategories.find(c => c.name === aiSuggestedName);
        
        if (matchedCategory) {
          categoryId = matchedCategory.id;
          method = 'ai_llm';
          status = 'ai_suggested';
        }
      }
    }
  }

  // Insertion avec logs d'audit
  const { error } = await supabase.from('transactions').insert({
    organization_id: org.id,
    description,
    amount: Math.round(amount * 100),
    type,
    category_id: categoryId,
    date: new Date(date).toISOString(),
    receipt_url: rawData.receipt_path?.toString() || null,
    classification_status: status,
    classification_method: method,
    metadata: { 
        engine: method === 'ai_llm' ? 'gpt-4o' : 'rules_engine_v1',
        applied_at: new Date().toISOString() 
    }
  });

  if (error) throw new Error(error.message);

  revalidatePath(`/${org_slug}`);
  revalidatePath(`/${org_slug}/budget`);
  redirect(`/${org_slug}`);
}

// --- âš™ï¸ 2. GESTION DES RÃˆGLES (SETTINGS) ---

export async function createRule(formData: FormData) {
  const supabase = await createClient();
  const org_slug = formData.get("org_slug") as string;
  const pattern = formData.get("pattern") as string;
  const category_id = formData.get("category_id") as string;

  const { data: org } = await supabase.from('organizations').select('id').eq('slug', org_slug).single();
  if (!org) throw new Error("Org introuvable");

  const { error } = await supabase.from('budget_rules').insert({
    organization_id: org.id,
    pattern,
    category_id
  });

  if (error) throw new Error(error.message);
  revalidatePath(`/${org_slug}/settings`);
}

export async function deleteRule(id: string, org_slug: string) {
  const supabase = await createClient();
  await supabase.from('budget_rules').delete().eq('id', id);
  revalidatePath(`/${org_slug}/settings`);
}

// --- âš–ï¸ 3. AUDIT & VALIDATION ---

export async function validateTransaction(transactionId: string, org_slug: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  await supabase.from('transactions').update({ classification_status: 'validated' }).eq('id', transactionId);

  await supabase.from('transaction_audit_logs').insert({
    transaction_id: transactionId,
    changed_by: user?.id,
    new_status: 'validated',
    notes: "Validation manuelle par l'auditeur"
  });

  revalidatePath(`/${org_slug}/budget`);
}
</file>

<file path="src/app/(dashboard)/[org_slug]/page.tsx">
import { getTransactions } from "./actions";
import { getBudgetAnalytics } from "./budget/analytics-actions"; // ğŸ‘ˆ IMPORT
import { CashflowChart } from "@/components/charts/cashflow-chart";
import { BudgetTreeView } from "@/components/dashboard/budget-tree-view"; // ğŸ‘ˆ IMPORT
import { TrendingUp, TrendingDown, Wallet } from "lucide-react";

export default async function DashboardPage({ 
  params 
}: { 
  params: Promise<{ org_slug: string }> 
}) {
  const { org_slug } = await params;
  
  // âš¡ï¸ Appel ParallÃ¨le pour la performance (Quant Style)
  // On rÃ©cupÃ¨re les transactions (pour le graph et KPIs) ET l'arbre (pour la structure)
  const [transactions, budgetTree] = await Promise.all([
     getTransactions(org_slug),
     getBudgetAnalytics(org_slug) 
  ]);

  // --- Calculs Financiers Globaux (KPIs) ---
  const totalIncome = transactions
    .filter(t => t.type === 'income')
    .reduce((acc, t) => acc + t.amount, 0);
    
  const totalExpense = transactions
    .filter(t => t.type === 'expense')
    .reduce((acc, t) => acc + t.amount, 0);

  const balance = totalIncome - totalExpense;

  // --- PrÃ©paration Graphique (Time Series) ---
  const monthlyStats = transactions.reduce((acc, t) => {
    const date = new Date(t.date);
    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    if (!acc[key]) acc[key] = { income: 0, expense: 0 };
    if (t.type === 'income') acc[key].income += t.amount;
    else acc[key].expense += t.amount;
    return acc;
  }, {} as Record<string, { income: number; expense: number }>);

  const chartData = Object.entries(monthlyStats)
    .sort((a, b) => a[0].localeCompare(b[0]))
    .slice(-6)
    .map(([key, val]) => {
        const [year, month] = key.split('-');
        const dateObj = new Date(parseInt(year), parseInt(month) - 1);
        return {
            month: dateObj.toLocaleDateString('fr-FR', { month: 'short' }),
            income: val.income / 100,
            expense: val.expense / 100
        };
    });

  const formatCurrency = (cents: number) => 
    new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(cents / 100);

  return (
    <div className="p-8 space-y-8 max-w-7xl mx-auto">
      
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
            <h1 className="text-2xl font-bold text-slate-900">Vue d'ensemble</h1>
            <p className="text-slate-500 text-sm">Pilotage de la trÃ©sorerie</p>
        </div>
        <div className="text-xs font-mono text-slate-400 bg-slate-50 px-3 py-1 rounded-full border border-slate-100">
          Sync: {new Date().toLocaleTimeString()}
        </div>
      </div>

      {/* KPI Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-slate-500 mb-1">Solde Total</p>
            <p className={`text-3xl font-bold ${balance >= 0 ? 'text-slate-900' : 'text-red-600'}`}>
                {formatCurrency(balance)}
            </p>
          </div>
          <div className="p-3 bg-blue-50 text-blue-600 rounded-lg">
            <Wallet className="w-6 h-6" />
          </div>
        </div>
        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-slate-500 mb-1">Recettes (Total)</p>
            <p className="text-2xl font-bold text-emerald-600">+{formatCurrency(totalIncome)}</p>
          </div>
          <div className="p-3 bg-emerald-50 text-emerald-600 rounded-lg">
            <TrendingUp className="w-6 h-6" />
          </div>
        </div>
        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-slate-500 mb-1">DÃ©penses (Total)</p>
            <p className="text-2xl font-bold text-red-600">-{formatCurrency(totalExpense)}</p>
          </div>
          <div className="p-3 bg-red-50 text-red-600 rounded-lg">
            <TrendingDown className="w-6 h-6" />
          </div>
        </div>
      </div>

      {/* Grid Principal : Graphique + Arbre Analytique */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* Colonne Gauche : Cashflow Chart (2/3) */}
        <div className="lg:col-span-2 space-y-6">
          <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
            <h3 className="font-semibold text-slate-900 mb-6">Flux de TrÃ©sorerie (6 mois)</h3>
            <CashflowChart data={chartData} />
          </div>
        </div>

        {/* Colonne Droite : Structure des CoÃ»ts (1/3) */}
        {/* âœ… REMPLACEMENT ICI : On utilise l'Arbre au lieu de la liste plate */}
        <div className="h-full min-h-[400px]">
           <BudgetTreeView data={budgetTree} />
        </div>

      </div>
    </div>
  );
}
</file>

<file path="src/app/globals.css">
@import "tailwindcss";

/* Tes styles perso ici */
body {
  background-color: #f8fafc;
  color: #0f172a;
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from "next";
import "./globals.css"; // <--- C'est cette ligne qui manquait peut-Ãªtre !
import { Inter } from "next/font/google";
import { Toaster } from "sonner"; 
const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Projet B - Fintech",
  description: "SaaS Association",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="fr">
      <body className={inter.className}>
        {children}
        <Toaster position="top-right" richColors />
      </body>
    </html>
  );
}
</file>

<file path="src/lib/ai.ts">
import OpenAI from "openai";
import { createClient } from "@/lib/supabase-server"; // ğŸ‘ˆ AjoutÃ© pour le Vector Search

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

/**
 * OPTION QUANT A : GÃ©nÃ©ration d'Embeddings (Vecteurs)
 * Transforme un texte en coordonnÃ©es mathÃ©matiques (1536 dimensions).
 */
export async function generateEmbedding(text: string) {
  const response = await openai.embeddings.create({
    model: "text-embedding-3-small",
    input: text,
  });
  return response.data[0].embedding;
}

/**
 * RECHERCHE VECTORIELLE : Trouve la catÃ©gorie la plus proche mathÃ©matiquement.
 * Plus performant et 100x moins cher qu'un LLM pour du gros volume.
 */
export async function findCategoryVectorial(description: string, orgId: string) {
  const supabase = await createClient();
  
  // 1. On gÃ©nÃ¨re la signature mathÃ©matique de la transaction
  const queryVector = await generateEmbedding(description);

  // 2. On interroge PostgreSQL via pgvector
  const { data: matches, error } = await supabase.rpc('match_categories', {
    query_embedding: queryVector,
    match_threshold: 0.5, // Seuil de confiance Ã  50%
    match_count: 1,       // On veut le meilleur rÃ©sultat
    org_id: orgId
  });

  if (error || !matches || matches.length === 0) {
    if (error) console.error("âŒ Erreur Vector Search:", error);
    return null;
  }

  return matches[0]; // Retourne { id, name, similarity }
}

/**
 * OPTION QUANT B : Classification Dynamique (LLM GPT-4o)
 * On injecte les catÃ©gories rÃ©elles pour une prÃ©cision chirurgicale sur les cas complexes.
 */
export async function categorizeTransaction(
  description: string, 
  amount: number, 
  availableCategories: string[]
): Promise<string> {
  if (!process.env.OPENAI_API_KEY) return "Non CatÃ©gorisÃ©";

  const categoriesList = availableCategories.join(", ");

  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: `Tu es un expert-comptable pour une association. 
          Liste des catÃ©gories autorisÃ©es : [${categoriesList}].
          
          Mission : Analyse la transaction et rÃ©ponds UNIQUEMENT par le nom de la catÃ©gorie la plus proche.
          Si aucune ne correspond vraiment, rÃ©ponds "Autre".`
        },
        {
          role: "user",
          content: `Transaction : "${description}" (${(amount / 100).toFixed(2)} EUR)`
        }
      ],
      temperature: 0, 
      max_tokens: 20,
    });

    return response.choices[0].message.content?.trim() || "Autre";
  } catch (error) {
    console.error("Erreur OpenAI:", error);
    return "Ã€ vÃ©rifier";
  }
}
</file>

<file path="src/lib/utils.ts">
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'jwogrpkuzmjmabkpsyrd.supabase.co',
        port: '',
        pathname: '/storage/v1/object/**',
      },
    ],
  },
};

export default nextConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    '@tailwindcss/postcss': {},
  },
};
export default config;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="src/app/(dashboard)/[org_slug]/budget/new/page.tsx">
'use client'; 

import { useState, use } from "react";
import { createTransaction } from "../../actions";
import { ReceiptUploader } from "@/components/forms/receipt-uploader"; 
import Link from "next/link";
import { ArrowLeft, Sparkles } from "lucide-react";

export default function NewTransactionPage({
  params,
}: {
  params: Promise<{ org_slug: string }>;
}) {
  const { org_slug } = use(params);

  // State pour gÃ©rer les valeurs du formulaire
  const [formData, setFormData] = useState({
    amount: "",
    description: "",
    category: "",
    date: new Date().toISOString().split('T')[0],
    type: "expense",
    receipt_path: "" // InitialisÃ© Ã  vide
  });

  // Fonction appelÃ©e quand l'IA a fini de lire le ticket
  const handleScanComplete = (data: any) => {
    setFormData((prev) => ({
      ...prev,
      amount: data.amount ? String(data.amount) : prev.amount,
      description: data.description || prev.description,
      category: data.category || prev.category,
      date: data.date || prev.date,
      // On sauvegarde le chemin du fichier reÃ§u du serveur
      receipt_path: data.receipt_path || prev.receipt_path || "" 
    }));
  };

  // Met Ã  jour le state quand l'utilisateur tape manuellement
  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  return (
    <div className="max-w-2xl mx-auto p-8">
      <Link 
        href={`/${org_slug}/budget`}
        className="text-sm text-slate-500 hover:text-slate-800 flex items-center gap-2 mb-6"
      >
        <ArrowLeft className="w-4 h-4" /> Retour au budget
      </Link>

      <h1 className="text-2xl font-bold mb-6">Ajouter une transaction</h1>
      
      <div className="bg-white p-6 rounded-xl shadow-sm border space-y-6">
        
        {/* ğŸ“¸ ZONE D'UPLOAD INTELLIGENTE */}
        <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
          <ReceiptUploader onScanComplete={handleScanComplete} />
        </div>

        <div className="relative flex py-2 items-center">
            <div className="flex-grow border-t border-slate-200"></div>
            <span className="flex-shrink-0 mx-4 text-slate-400 text-xs uppercase">DÃ©tails de l'opÃ©ration</span>
            <div className="flex-grow border-t border-slate-200"></div>
        </div>

        {/* Formulaire classique */}
        <form action={createTransaction} className="space-y-6">
          <input type="hidden" name="org_slug" value={org_slug} />
          
          {/* âœ… PROTECTION : Le fallback || "" empÃªche l'erreur React */}
          <input type="hidden" name="receipt_path" value={formData.receipt_path || ""} />

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1">Type</label>
              <select 
                name="type" 
                value={formData.type}
                onChange={handleChange}
                className="w-full p-2 border rounded-md bg-white outline-none focus:ring-2 focus:ring-black"
              >
                <option value="expense">ğŸ”´ DÃ©pense</option>
                <option value="income">ğŸŸ¢ Recette</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Montant (â‚¬)</label>
              <input 
                name="amount" 
                type="number" 
                step="0.01" 
                placeholder="0.00" 
                required 
                value={formData.amount}
                onChange={handleChange}
                className="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-black"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium mb-1 flex items-center gap-2">
              CatÃ©gorie 
              {formData.category && (
                <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full flex items-center gap-1 animate-pulse">
                  <Sparkles className="w-3 h-3" /> Auto-dÃ©tectÃ©e
                </span>
              )}
            </label>
            <input 
              name="category" 
              type="text" 
              placeholder="Ex: Alimentation, Transport... (Laisser vide pour IA)" 
              value={formData.category}
              onChange={handleChange}
              className="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-black"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Date</label>
            <input 
              name="date" 
              type="date" 
              required 
              value={formData.date}
              onChange={handleChange}
              className="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-black"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Description (Optionnel)</label>
            <textarea 
              name="description" 
              rows={3} 
              placeholder="DÃ©tails de l'opÃ©ration..." 
              value={formData.description}
              onChange={handleChange}
              className="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-black"
            ></textarea>
          </div>

          <div className="flex justify-end gap-3 pt-4 border-t border-slate-100">
            <Link 
              href={`/${org_slug}/budget`}
              className="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition"
            >
              Annuler
            </Link>
            <button 
              type="submit" 
              className="px-6 py-2 bg-black text-white rounded-md hover:bg-gray-800 font-medium transition shadow-md"
            >
              Enregistrer
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/[org_slug]/budget/actions.ts">
"use server";

import { createClient } from "@/lib/supabase-server";
import { redirect } from "next/navigation";
import { revalidatePath } from "next/cache";
import { categorizeTransaction } from "@/lib/ai"; // Le cerveau IA
import { stripe } from "@/lib/stripe"; // La banque

// ============================================================================
// ACTION 1 : CRÃ‰ATION INTERNE (IA & MANUEL)
// UtilisÃ© par le trÃ©sorier pour ajouter une dÃ©pense ou une recette cash
// ============================================================================
export async function createTransaction(formData: FormData) {
  const supabase = await createClient();
  
  // 1. VÃ©rif Auth
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;

  // 2. RÃ©cupÃ©ration des donnÃ©es
  const org_slug = formData.get("org_slug") as string;
  const amountStr = formData.get("amount") as string;
  const amount = parseFloat(amountStr);
  const type = formData.get("type") as string;
  const description = formData.get("description") as string;
  const date = formData.get("date") as string;
  
  // Variable mutable pour la catÃ©gorie
  let category = formData.get("category") as string;

  // 3. LOGIQUE IA : Si la catÃ©gorie est vide, l'IA prend le relais
  if (!category || category.trim() === "") {
    console.log("ğŸ¤– Appel Ã  OpenAI pour :", description);
    // On attend la rÃ©ponse de GPT (Ã§a peut prendre 1 Ã  2 secondes)
    category = await categorizeTransaction(description, amount);
    console.log("âœ… Verdict OpenAI :", category);
  }

  // 4. RÃ©cupÃ©rer l'ID de l'asso
  const { data: org } = await supabase
    .from("organizations")
    .select("id")
    .eq("slug", org_slug)
    .single();

  if (!org) throw new Error("Organisation introuvable");

  // 5. Sauvegarde en base
  const amountInCents = Math.round(amount * 100);

  const { error } = await supabase.from("transactions").insert({
    organization_id: org.id,
    profile_id: user.id, // On garde une trace de qui a ajoutÃ© la ligne
    amount: amountInCents,
    type,
    category, // Ici, c'est soit la saisie manuelle, soit l'IA
    description,
    date: new Date(date).toISOString(),
    status: "pending", // Par dÃ©faut, une saisie manuelle peut nÃ©cessiter validation
  });

  if (error) {
    console.error("Erreur Supabase:", error);
    return;
  }

  revalidatePath(`/${org_slug}/budget`);
  redirect(`/${org_slug}/budget`);
}

// ============================================================================
// ACTION 2 : GÃ‰NÃ‰RATION DE LIEN DE PAIEMENT (STRIPE)
// UtilisÃ© pour vendre des places ou encaisser des cotisations
// ============================================================================
export async function createCheckoutSession(org_slug: string, amount: number, title: string) {
  const supabase = await createClient();

  // 1. RÃ©cupÃ©rer l'ID Stripe de l'asso
  const { data: org } = await supabase
    .from('organizations')
    .select('id, stripe_account_id')
    .eq('slug', org_slug)
    .single();

  if (!org || !org.stripe_account_id) {
    throw new Error("L'association n'a pas connectÃ© son compte Stripe dans les RÃ©glages.");
  }

  // 2. CrÃ©er la session Stripe
  const session = await stripe.checkout.sessions.create({
    mode: 'payment',
    payment_method_types: ['card'],
    line_items: [
      {
        price_data: {
          currency: 'eur',
          product_data: {
            name: title, // Ex: "Place Gala 2026"
          },
          unit_amount: Math.round(amount * 100), // En centimes
        },
        quantity: 1,
      },
    ],
    metadata: {
      org_id: org.id,         // CRITIQUE : Pour que le webhook retrouve l'asso
      category: "Billetterie", // Par dÃ©faut pour les ventes en ligne
      description: title,
    },
    payment_intent_data: {
      application_fee_amount: 100, // Ta commission plateforme (1.00â‚¬)
      transfer_data: {
        destination: org.stripe_account_id, // L'argent part chez l'asso
      },
    },
    // Redirections aprÃ¨s paiement
    success_url: `${process.env.NEXT_PUBLIC_APP_URL}/${org_slug}/budget?payment=success`,
    cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/${org_slug}/budget?payment=cancelled`,
  });

  // 3. Rediriger l'utilisateur vers la page de paiement Stripe
  if (session.url) {
    redirect(session.url);
  }
}
</file>

<file path="src/app/api/webhooks/stripe/route.ts">
import { headers } from "next/headers";
import { NextResponse } from "next/server";
import { stripe } from "@/lib/stripe";
import { createClient } from "@supabase/supabase-js"; // âš ï¸ On utilise le client officiel directement
import Stripe from "stripe";

export async function POST(req: Request) {
  const body = await req.text();
  const signature = (await headers()).get("Stripe-Signature") as string;

  let event: Stripe.Event;

  try {
    // 1. VÃ©rification de la signature (SÃ©curitÃ© absolue)
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
  } catch (error: any) {
    console.error(`âŒ Erreur Signature Webhook: ${error.message}`);
    return new NextResponse(`Webhook Error: ${error.message}`, { status: 400 });
  }

  // 2. Traitement de l'Ã©vÃ©nement
  if (event.type === "checkout.session.completed") {
    const session = event.data.object as Stripe.Checkout.Session;
    
    // On rÃ©cupÃ¨re les mÃ©tadonnÃ©es
    const orgId = session.metadata?.org_id;
    const category = session.metadata?.category || "Autre";
    const description = session.metadata?.description || "Paiement Stripe";

    if (orgId) {
      // âš ï¸ CRÃ‰ATION DU CLIENT ADMIN (SERVICE ROLE)
      // Ce client contourne TOUTES les sÃ©curitÃ©s RLS. Il a tous les droits d'Ã©criture.
      const supabaseAdmin = createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
      );
      
      const amount = session.amount_total || 0; // En centimes

      // Insertion dans la compta
      const { error } = await supabaseAdmin.from("transactions").insert({
        organization_id: orgId,
        amount: amount,
        type: "income", // C'est une recette
        description: `${description} (${session.customer_details?.email})`,
        category: category,
        date: new Date().toISOString(),
        status: "verified", // Statut validÃ©
      });
      
      if (error) {
        console.error("âŒ ERREUR SUPABASE (Insert transaction) :", error);
        return new NextResponse("Database Error", { status: 500 });
      }

      console.log(`ğŸ’° SuccÃ¨s ! Transaction de ${amount/100}â‚¬ enregistrÃ©e pour l'asso ${orgId}`);
    }
  }

  return new NextResponse(null, { status: 200 });
}
</file>

<file path="src/app/onboarding/actions.ts">
"use server";

import { createClient } from "@/lib/supabase-server";
import { redirect } from "next/navigation";
import { revalidatePath } from "next/cache";

export async function createOrganization(formData: FormData) {
  const supabase = await createClient();

  // 1. VÃ©rifier qui est connectÃ©
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect("/login");
  }

  // 2. RÃ©cupÃ©rer le nom de l'asso depuis le formulaire
  const orgName = formData.get("orgName") as string;
  
  if (!orgName) {
    return; // On pourrait gÃ©rer une erreur ici
  }

  // 3. GÃ©nÃ©rer un "slug" (URL friendly)
  // Ex: "BDE ESIEE 2026" devient "bde-esiee-2026"
  const slug = orgName
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g, "") // Enlever les caractÃ¨res spÃ©ciaux
    .replace(/[\s_-]+/g, "-") // Remplacer les espaces par des tirets
    .replace(/^-+|-+$/g, ""); // Enlever les tirets au dÃ©but/fin

  // 4. CrÃ©er l'Organisation
  const { data: org, error: orgError } = await supabase
    .from("organizations")
    .insert({
      name: orgName,
      slug: slug,
    })
    .select()
    .single();

  if (orgError) {
    console.error("Erreur crÃ©ation Asso:", orgError);
    // Si le slug existe dÃ©jÃ  (ex: esiee-maroc), on pourrait ajouter un random number
    // Mais pour l'instant on laisse planter (MVP)
    throw new Error("Impossible de crÃ©er l'association (Nom peut-Ãªtre dÃ©jÃ  pris ?)");
  }

  // 5. Ajouter l'utilisateur comme ADMIN de cette asso
  const { error: memberError } = await supabase
    .from("members")
    .insert({
      user_id: user.id,
      organization_id: org.id,
      role: "admin", // Le crÃ©ateur est chef !
    });

  if (memberError) {
    console.error("Erreur ajout membre:", memberError);
    throw new Error("Erreur lors de l'ajout du membre");
  }

  // 6. Redirection vers le Dashboard de la nouvelle asso
  revalidatePath("/");
  redirect(`/${slug}/budget`);
}
export async function joinOrganization(formData: FormData) {
  const supabase = await createClient();
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect("/login");

  const slug = formData.get("slug") as string;

  // 1. Trouver l'ID de l'asso
  const { data: org, error: orgFetchError } = await supabase
    .from("organizations")
    .select("id")
    .eq("slug", slug)
    .single();

  if (orgFetchError || !org) {
    throw new Error("Association introuvable");
  }

  // 2. LOG DE DÃ‰BOGAGE (Regarde ton terminal VS Code)
  console.log(`Tentative d'adhÃ©sion : User ${user.id} -> Org ${org.id}`);

  // 3. CrÃ©er la demande
  const { error } = await supabase
    .from("members")
    .insert({
      user_id: user.id,
      organization_id: org.id,
      role: 'membre',
      status: 'pending' 
    });

  if (error) {
    console.error("Erreur SQL dÃ©taillÃ©e :", error); // <--- TrÃ¨s important pour voir le vrai coupable
    
    if (error.code === '23505') {
      throw new Error(`Erreur : Tu es dÃ©jÃ  enregistrÃ© dans cette association (ID: ${user.id.slice(0,5)}...)`);
    }
    throw new Error(`Erreur Supabase : ${error.message}`);
  }

  return { success: true };
}
</file>

<file path="src/lib/stripe.ts">
// src/lib/stripe.ts
import Stripe from 'stripe';

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2026-01-28.clover',
  typescript: true,
});
</file>

<file path="src/app/onboarding/page.tsx">
"use client"; // On passe en Client Component pour gÃ©rer les onglets

import { useState } from "react";
import { createOrganization, joinOrganization } from "./actions"; 
import { Building2, UserPlus } from "lucide-react"; 

export default function OnboardingPage() {
  const [mode, setMode] = useState<"create" | "join">("create");

  // --- Handlers pour Ã©viter les erreurs de type TypeScript ---
  
  const handleCreate = async (formData: FormData) => {
    // Wrapper pour l'action serveur de crÃ©ation
    await createOrganization(formData);
  };

  const handleJoin = async (formData: FormData) => {
    // Wrapper pour l'action serveur de candidature
    await joinOrganization(formData);
  };

  // -----------------------------------------------------------

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
      <div className="max-w-md w-full bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
        
        {/* Header Toggle */}
        <div className="flex border-b border-slate-100">
          <button
            onClick={() => setMode("create")}
            className={`flex-1 py-4 text-sm font-medium flex items-center justify-center gap-2 ${
              mode === "create" ? "bg-white text-slate-900" : "bg-slate-50 text-slate-500 hover:bg-slate-100"
            }`}
          >
            <Building2 className="w-4 h-4" /> CrÃ©er une asso
          </button>
          <button
            onClick={() => setMode("join")}
            className={`flex-1 py-4 text-sm font-medium flex items-center justify-center gap-2 ${
              mode === "join" ? "bg-white text-slate-900" : "bg-slate-50 text-slate-500 hover:bg-slate-100"
            }`}
          >
            <UserPlus className="w-4 h-4" /> Rejoindre
          </button>
        </div>

        <div className="p-8">
          <div className="text-center mb-8">
            <h1 className="text-2xl font-bold text-slate-900 mb-2">
              {mode === "create" ? "Lance ton espace" : "Rejoins ton Ã©quipe"}
            </h1>
            <p className="text-slate-500 text-sm">
              {mode === "create" 
                ? "Deviens Admin et gÃ¨re la trÃ©sorerie." 
                : "Entre le code (slug) de l'asso pour postuler."}
            </p>
          </div>

          {mode === "create" ? (
            /* FORMULAIRE CRÃ‰ATION */
            <form action={handleCreate} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">Nom de l'asso</label>
                <input name="orgName" type="text" required placeholder="Ex: ESIEE Maroc" className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-black outline-none" />
              </div>
              <button type="submit" className="w-full bg-black text-white py-3 rounded-lg font-medium hover:bg-slate-800 transition">CrÃ©er et AccÃ©der</button>
            </form>
          ) : (
            /* FORMULAIRE REJOINDRE */
            <form action={handleJoin} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">Identifiant Asso (Slug)</label>
                <input name="slug" type="text" required placeholder="Ex: esiee-maroc" className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-black outline-none" />
                <p className="text-xs text-slate-400 mt-1">Demande l'identifiant Ã  ton prÃ©sident.</p>
              </div>
              <button type="submit" className="w-full bg-white border border-slate-300 text-slate-700 py-3 rounded-lg font-medium hover:bg-slate-50 transition">Envoyer ma candidature</button>
            </form>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="package.json">
{
  "name": "projet-asso-fintech",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@stripe/stripe-js": "^8.7.0",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.95.3",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.563.0",
    "next": "16.1.6",
    "openai": "^6.21.0",
    "radix-ui": "^1.4.3",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "recharts": "2.15.4",
    "sonner": "^2.0.7",
    "stripe": "^20.3.1",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.3.6"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.6",
    "shadcn": "^3.8.4",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}
</file>

<file path="src/app/(dashboard)/[org_slug]/budget/page.tsx">
import { createClient } from "@/lib/supabase-server";
import { redirect } from "next/navigation";
import Link from "next/link";
import { CashflowChart } from "@/components/charts/cashflow-chart"; 
import { ExpenseDonutChart } from "@/components/charts/expense-donut-chart"; 
import { EventCard } from "@/components/dashboard/event-card"; 
import { TransactionDetailSheet } from "@/components/dashboard/transaction-detail-sheet";
import { getTransactions, validateTransaction } from "../actions"; 
import { getBudgetAnalytics, getFinancialHealth } from "./analytics-actions"; // âœ… Import groupÃ©
import { RunwayCard } from "@/components/dashboard/runway-card"; // âœ… Le composant prÃ©dictif
import { Sparkles, CheckCircle2, Clock, Gavel, UserCheck, ShieldAlert } from "lucide-react"; 

const formatCurrency = (amountInCents: number) => {
  return new Intl.NumberFormat("fr-FR", {
    style: "currency",
    currency: "EUR",
  }).format(amountInCents / 100);
};

function aggregateTransactionsByMonth(transactions: any[]) {
  const months: Record<string, { month: string; income: number; expense: number }> = {};
  for (let i = 5; i >= 0; i--) {
    const d = new Date();
    d.setMonth(d.getMonth() - i);
    const key = d.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
    const label = d.toLocaleString('fr-FR', { month: 'short' }); 
    months[key] = { month: label, income: 0, expense: 0 };
  }
  transactions.forEach((t) => {
    const date = new Date(t.date);
    const key = date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
    if (months[key]) {
      if (t.type === 'income') months[key].income += t.amount / 100;
      else months[key].expense += t.amount / 100;
    }
  });
  return Object.values(months);
}

export default async function BudgetPage({
  params,
}: {
  params: Promise<{ org_slug: string }>;
}) {
  const { org_slug } = await params;
  const supabase = await createClient();

  const { data: org, error: orgError } = await supabase
    .from("organizations")
    .select("id, name")
    .eq("slug", org_slug)
    .single();

  if (orgError || !org) return <div className="p-8 text-red-500">Organisation introuvable</div>;

  // âš¡ï¸ PERFORMANCE QUANT : Chargement parallÃ¨le incluant la santÃ© financiÃ¨re
  const [allTransactions, budgetTree, financialHealth, { data: events }] = await Promise.all([
    getTransactions(org_slug),
    getBudgetAnalytics(org_slug),
    getFinancialHealth(org_slug), // ğŸ”® PrÃ©diction Runway
    supabase.from('events').select('*').eq('organization_id', org.id).order('date', { ascending: true })
  ]);

  const totalIncome = allTransactions.filter((t) => t.type === "income").reduce((sum, t) => sum + t.amount, 0);
  const totalExpense = allTransactions.filter((t) => t.type === "expense").reduce((sum, t) => sum + t.amount, 0);
  const currentBalance = totalIncome - totalExpense;
  const chartData = aggregateTransactionsByMonth(allTransactions);

  return (
    <div className="p-8 max-w-[1600px] mx-auto space-y-10">
      
      {/* --- HEADER --- */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-slate-900 tracking-tight">{org.name}</h1>
          <p className="text-slate-500 font-medium tracking-tight italic">Financial Suite â€” Master Option B</p>
        </div>
        <Link 
          href={`/${org_slug}/budget/new`}
          className="w-full md:w-auto px-6 py-2.5 bg-slate-900 text-white rounded-xl text-sm font-bold hover:bg-slate-800 transition shadow-md active:scale-95 text-center"
        >
          + Nouvelle OpÃ©ration
        </Link>      
      </div>

      {/* --- KPI CARDS (GRID 4 COLONNES) --- */}
      <div className="grid gap-6 md:grid-cols-2 xl:grid-cols-4">
        
        {/* 1. Solde */}
        <div className="p-6 bg-white rounded-2xl shadow-sm border border-slate-200">
          <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Balance TrÃ©sorerie</h3>
          <p className={`text-3xl font-black mt-2 ${currentBalance < 0 ? "text-red-600" : "text-slate-900"}`}>
            {formatCurrency(currentBalance)}
          </p>
        </div>

        {/* 2. Recettes */}
        <div className="p-6 bg-white rounded-2xl shadow-sm border border-slate-200">
          <h3 className="text-[10px] font-black text-emerald-500 uppercase tracking-widest">Total Recettes</h3>
          <p className="text-3xl font-black mt-2 text-emerald-600">+{formatCurrency(totalIncome)}</p>
        </div>

        {/* 3. DÃ©penses */}
        <div className="p-6 bg-white rounded-2xl shadow-sm border border-slate-200">
          <h3 className="text-[10px] font-black text-red-500 uppercase tracking-widest">Total DÃ©penses</h3>
          <p className="text-3xl font-black mt-2 text-red-600">-{formatCurrency(totalExpense)}</p>
        </div>

        {/* 4. ğŸ”® RUNWAY (PrÃ©diction) */}
        <RunwayCard health={financialHealth} />
      </div>

      {/* --- CHARTS --- */}
      <div className="grid gap-8 lg:grid-cols-2">
        <div className="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
          <h3 className="text-lg font-bold mb-6">Cashflow (6m)</h3>
          <CashflowChart data={chartData} />
        </div>
        <div className="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col">
          <h3 className="text-lg font-bold mb-6">Allocation des fonds</h3>
          <div className="flex-1 flex items-center justify-center">
            <ExpenseDonutChart data={budgetTree} />
          </div>
        </div>
      </div>

      {/* --- JOURNAL D'AUDIT HYBRIDE (IA + RÃˆGLES) --- */}
      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="px-6 py-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
          <h3 className="font-bold text-slate-900 flex items-center gap-2">
            Journal d'Audit
            <span className="px-2 py-0.5 bg-indigo-100 text-indigo-700 text-[9px] rounded-full uppercase tracking-tighter font-black">
              Hybrid Classifier
            </span>
          </h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-slate-50/50 border-b border-slate-100">
                <th className="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Date</th>
                <th className="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">DÃ©signation & MÃ©thode</th>
                <th className="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Status Audit</th>
                <th className="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Montant</th>
                <th className="px-6 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Action</th>
              </tr>
            </thead>
            <tbody>
              {allTransactions.map((t) => (
                <tr key={t.id} className="border-b last:border-0 hover:bg-slate-50/80 transition-colors group">
                  <td className="px-6 py-4 text-xs font-mono text-slate-500">
                    {new Date(t.date).toLocaleDateString("fr-FR", { day: '2-digit', month: '2-digit' })}
                  </td>
                  <td className="px-6 py-4">
                    <div className="flex flex-col">
                        <span className="text-sm font-bold text-slate-900 group-hover:text-indigo-600 transition-colors tracking-tight">
                          {t.description || "Sans libellÃ©"}
                        </span>
                        
                        {/* ğŸ›¡ï¸ BADGES DE TRAÃ‡ABILITÃ‰ (Audit Trail) */}
                        <div className="flex items-center gap-2 mt-1.5">
                          <div className="flex items-center gap-1">
                            <div className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: t.budget_categories?.color || '#cbd5e1' }} />
                            <span className="text-[10px] text-slate-400 uppercase font-black tracking-tighter">
                              {t.budget_categories?.name || "Non classÃ©"}
                            </span>
                          </div>

                          {t.classification_method === 'hard_rule' && (
                            <span className="flex items-center gap-1 text-[8px] font-bold bg-emerald-50 text-emerald-700 px-1.5 py-0.5 rounded border border-emerald-100 uppercase tracking-tighter">
                              <Gavel className="w-2.5 h-2.5" /> RÃ¨gle MÃ©tier
                            </span>
                          )}
                          {t.classification_method === 'ai_llm' && (
                            <span className="flex items-center gap-1 text-[8px] font-bold bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-100 uppercase tracking-tighter">
                              <Sparkles className="w-2.5 h-2.5" /> IA SuggÃ©rÃ©
                            </span>
                          )}
                          {t.classification_method === 'manual' && (
                            <span className="flex items-center gap-1 text-[8px] font-bold bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded border border-slate-200 uppercase tracking-tighter">
                              <UserCheck className="w-2.5 h-2.5" /> Manuel
                            </span>
                          )}
                        </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 text-center">
                    <div className="flex flex-col items-center">
                      {t.classification_status === 'validated' ? (
                        <div className="flex items-center gap-1 text-[9px] font-black text-emerald-600 bg-emerald-50 px-2.5 py-1 rounded-full border border-emerald-100">
                          <CheckCircle2 className="w-3 h-3" /> VÃ‰RIFIÃ‰
                        </div>
                      ) : t.classification_status === 'ai_suggested' ? (
                        <div className="flex items-center gap-1 text-[9px] font-black text-indigo-600 bg-indigo-50 px-2.5 py-1 rounded-full border border-indigo-100">
                          <Clock className="w-3 h-3" /> Ã€ VALIDER
                        </div>
                      ) : (
                        <div className="flex items-center gap-1 text-[9px] font-black text-amber-600 bg-amber-50 px-2.5 py-1 rounded-full border border-amber-100">
                          <ShieldAlert className="w-3 h-3" /> PENDING
                        </div>
                      )}
                    </div>
                  </td>
                  <td className={`px-6 py-4 text-right font-mono font-bold text-sm ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-900'}`}>
                    {t.type === 'expense' ? '-' : '+'}{formatCurrency(t.amount)}
                  </td>
                  <td className="px-6 py-4 text-center">
                    {t.classification_status === 'ai_suggested' ? (
                      <form action={async () => {
                        'use server';
                        await validateTransaction(t.id, org_slug);
                      }}>
                        <button 
                          type="submit"
                          className="p-2 text-indigo-600 hover:bg-indigo-600 hover:text-white rounded-lg transition-all border border-indigo-100 shadow-sm active:scale-90"
                          title="Valider la suggestion IA"
                        >
                          <CheckCircle2 className="w-4 h-4" />
                        </button>
                      </form>
                    ) : (
                      <div className="text-slate-200 font-mono text-[10px]">FIXED</div>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
</file>

</files>
